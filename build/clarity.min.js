var CLARITY={ctx:document.createElement("canvas").getContext("2d")};CLARITY.Filter=function(t){var t=t||{};this.channel=t.channel||"grey"},CLARITY.Filter.prototype={process:function(t){return t},getColourValue:function(t,e,a){var a=this.channel||a||"grey";switch(a){case"grey":return.2989*t.data[e+0]+.587*t.data[e+1]+.114*t.data[e+2];case"red":case"r":return t.data[e+0];case"green":case"g":return t.data[e+1];case"blue":case"b":return t.data[e+2];default:return.2989*t.data[e+0]+.587*t.data[e+1]+.114*t.data[e+2]}}},CLARITY.Operations={RGBtoHSV:function(t){for(var e,a,i,r,s,h,o,d,n,c=0;c<t.data.length;c+=4){if(e=t.data[c],a=t.data[c+1],i=t.data[c+2],o=minimum([e,a,i]),d=maximum([e,a,i]),h=d,n=d-o,0==d)return s=0,void(r=-1);s=n/d,r=e==d?(a-i)/n:a==d?2+(i-e)/n:4+(e-a)/n,r*=60,0>r&&(r+=360),t.data[c]=r,t.data[c+1]=s,t.data[c+2]=h}},HSVtoRGB:function(t){for(var e,a,i,r,s,h,o,d,n,c,l,u=0;u<t.data.length;u+=4)if(s=t.data[u],h=t.data[u+1],o=t.data[u+2],0!=h){switch(s/=60,e=Math.floor(s),d=s-e,n=o*(1-h),c=o*(1-h*d),l=o*(1-h*(1-d)),e){case 0:a=o,i=l,r=n;break;case 1:a=c,i=o,r=n;break;case 2:a=n,i=o,r=l;break;case 3:a=n,i=c,r=o;break;case 4:a=l,i=n,r=o;break;default:a=o,i=n,r=c}t.data[u]=a,t.data[u+1]=i,t.data[u+2]=r}else a=i=r=o},minimum:function(t){for(var e=256,a=0;a<t.length;a++)t[a]<e&&(e=t[a]);return e},maximum:function(t){for(var e=0,a=0;a<t.length;a++)t[a]>e&&(e=t[a]);return e}},CLARITY.Pixel=function(t,e,a){this.r=0,this.g=0,this.b=0,this.h=0,this.s=0,this.v=0,this.setFromRGB(t,e,a)},CLARITY.Pixel.prototype={getColourValue:function(t){var t=this.channel||t||"grey";switch(t){case"grey":return.2989*this.r+.587*this.g+.114*this.b;case"red":case"r":return this.r;case"green":case"g":return this.g;case"blue":case"b":return this.b;case"hue":case"h":return this.h;case"saturation":case"s":return this.s;case"value":case"v":return this.v;default:return.2989*this.r+.587*this.g+.114*this.b}},setFromRGB:function(t,e,a){var i,r,s;return this.r=t,this.g=e,this.b=a,i=minimum([this.r,this.g,this.b]),r=maximum([this.r,this.g,this.b]),this.v=r,s=r-i,0==r?(this.s=0,void(this.h=-1)):(this.s=s/r,this.h=this.r==r?(this.g-this.b)/s:this.g==r?2+(this.b-this.r)/s:4+(this.r-this.g)/s,this.h*=60,void(this.h<0&&(this.h+=360)))},setFromHSV:function(t,e,a){var i,r,s,h,o;if(this.h=t,this.s=e,this.v=a,0==this.s)return void(this.r=this.g=this.b=this.v);switch(i=Math.floor(this.h/60),r=this.h-i,s=this.v*(1-this.s),h=this.v*(1-this.s*r),o=this.v*(1-this.s*(1-r)),i){case 0:this.r=a,this.g=o,this.b=s;break;case 1:this.r=h,this.g=a,this.b=s;break;case 2:this.r=s,this.g=a,this.b=o;break;case 3:this.r=s,this.g=h,this.b=a;break;case 4:this.r=o,this.g=s,this.b=a;break;default:this.r=a,this.g=s,this.b=h}}},CLARITY.Contourer=function(t){var t=t||{};this.contours=t.contours||10,this.threshes=[128,256],this.threshSets=[0,256],this.difference=128,this.maxValue=0,this.minValue=255,CLARITY.Filter.call(this,t)},CLARITY.Contourer.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Contourer.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.data.length;a+=4)t.data[a]>this.maxValue?this.maxValue=t.data[a]:t.data[a]<this.minValue&&(this.minValue=t.data[a]);this.setVar(this.contours);for(var a=0;a<t.data.length;a++)if((a+1)%4!=0){for(var i=0;i<this.threshes.length;i++)if(t.data[a]<this.threshes[i]){e.data[a]=this.threshSets[i];break}}else e.data[a]=255;return e},CLARITY.Contourer.prototype.setVar=function(t){this.threshes=[],this.difference=(this.maxValue-this.minValue)/t;for(var e=0,a=this.difference+this.minValue;256>=a;a+=this.difference)this.threshes[e]=a,this.threshSets[e]=(a-this.difference-this.minValue)/(this.maxValue-this.minValue)*255,e++;this.threshes[e]=a,this.threshSets[e]=255},CLARITY.NormalGenerator=function(t){var t=t||{};this.heightMod=t.heightMod||.15,CLARITY.Filter.call(this,t)},CLARITY.NormalGenerator.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.NormalGenerator.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=1;a<t.height-1;a++)for(var i=1;i<t.width-1;i++){var r=4*(a*t.width+i),s=4*((a-1)*t.width+i),h=4*((a+1)*t.width+i),o=4*(a*t.width+(i-1)),d=4*(a*t.width+(i+1)),n={x:i,y:a,z:this.heightMod*t.data[r]},c={x:i,y:a-1,z:this.heightMod*t.data[s]},l={x:i,y:a+1,z:this.heightMod*t.data[h]},u={x:i-1,y:a,z:this.heightMod*t.data[o]},f={x:i+1,y:a,z:this.heightMod*t.data[d]},p=this.generateNormal(n,u,f,c,l);e.data[r]=255-(p.x/2+128),e.data[r+1]=255-(p.y/2+128),e.data[r+2]=-p.z,e.data[r+3]=255}return e},CLARITY.NormalGenerator.prototype.generateNormal=function(t,e,a,i,r){var s=this.calcNormal(t,i,e),h=this.calcNormal(t,e,r),o=this.calcNormal(t,r,a),d=this.calcNormal(t,a,i),n=this.average(s,h,o,d);return n},CLARITY.NormalGenerator.prototype.calcNormal=function(t,e,a){var i=this.vectorSub(t,e),r=this.vectorSub(t,a),s=this.crossProduct(i,r);return s=this.normalise(s)},CLARITY.NormalGenerator.prototype.vectorSub=function(t,e){return{x:t.x-e.x,y:t.y-e.y,z:t.z-e.z}},CLARITY.NormalGenerator.prototype.vectorAdd=function(t,e){return{x:t.x+e.x,y:t.y+e.y,z:t.z+e.z}},CLARITY.NormalGenerator.prototype.crossProduct=function(t,e){return{x:t.y*e.z-t.z*e.y,y:-(t.x*e.z-t.z*e.x),z:t.x*e.y-t.y*e.x}},CLARITY.NormalGenerator.prototype.normalise=function(t){var e=Math.sqrt(Math.abs(t.x*t.x+t.y*t.y+t.z*t.z));return{x:t.x/e,y:t.y/e,z:t.z/e}},CLARITY.NormalGenerator.prototype.average=function(t,e,a,i){var r=this.vectorAdd(t,e);return r=this.vectorAdd(r,a),r=this.vectorAdd(r,i),r=this.normalise(r),{x:255*r.x,y:255*r.y,z:255*r.z}},CLARITY.DotRemover=function(t){var t=t||{};this.neighboursReq=t.neighboursReq||1,CLARITY.Filter.call(this,t)},CLARITY.DotRemover.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DotRemover.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=1;a<t.height-1;a++)for(var i=1;i<t.width-1;i++){var r=4*(a*t.width+i),s=4*((a-1)*t.width+i),h=4*((a+1)*t.width+i),o=4*(a*t.width+(i-1)),d=4*(a*t.width+(i+1)),n=t.data[r],c=0;t.data[s]==n&&c++,t.data[h]==n&&c++,t.data[o]==n&&c++,t.data[d]==n&&c++,c<=this.neighboursReq?n>138?(e.data[r]=0,e.data[r+1]=0,e.data[r+2]=0):(e.data[r]=255,e.data[r+1]=255,e.data[r+2]=255):(e.data[r]=n,e.data[r+1]=n,e.data[r+2]=n),e.data[r+3]=255}return e},CLARITY.Posteriser=function(t){this.threshes=[128,256],this.difference=32,this.setThresh(64),CLARITY.Filter.call(this,t)},CLARITY.Posteriser.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Posteriser.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.data.length;a++)if((a+1)%4!=0){for(var i=0;i<this.threshes.length;i++)if(t.data[a]<this.threshes[i]){e.data[a]=this.threshes[i]-this.difference/2;break}}else e.data[a]=255;return e},CLARITY.Posteriser.prototype.setThresh=function(t){this.threshes=[],this.difference=t;for(var e=0,a=this.difference;256>=a;a+=this.difference)this.threshes[e]=a,e++;this.threshes[e]=a},CLARITY.Smoother=function(t){var t=t||{};this.distance=t.distance||1,this.iterations=t.iterations||1,CLARITY.Filter.call(this,t)},CLARITY.Smoother.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Smoother.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<this.iterations;a++)for(var i=this.distance;i<t.height-this.distance;i++)for(var r=this.distance;r<t.width-this.distance;r++){var s=4*(i*t.width+r),h=4*((i-this.distance)*t.width+r),o=4*((i+this.distance)*t.width+r),d=4*(i*t.width+(r-this.distance)),n=4*(i*t.width+(r+this.distance));e.data[s+0]=(t.data[d+0]+t.data[n+0]+t.data[h+0]+t.data[o+0])/4,e.data[s+1]=(t.data[d+1]+t.data[n+1]+t.data[h+1]+t.data[o+1])/4,e.data[s+2]=(t.data[d+2]+t.data[n+2]+t.data[h+2]+t.data[o+2])/4,e.data[s+3]=255}return e},CLARITY.EdgeDetector=function(t){var t=t||{};this.fast=t.fast||!1,this.channel=t.channel||"grey",this.kernel=[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],CLARITY.Filter.call(this,t)},CLARITY.EdgeDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.EdgeDetector.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);if(this.fast)for(var a=4;a<4*t.height-4;a+=4)for(var i=4;i<4*t.width-4;i+=4){var r=a*t.width+i;e.data[r]=5*Math.abs(this.getColourValue(t,r+4)-this.getColourValue(t,r)),e.data[r+1]=5*Math.abs(this.getColourValue(t,r+4)-this.getColourValue(t,r)),e.data[r+2]=5*Math.abs(this.getColourValue(t,r+4)-this.getColourValue(t,r)),e.data[r+3]=255}else for(var a=4;a<4*t.height-4;a+=4)for(var i=4;i<4*t.width-4;i+=4){for(var s=0,h=-1;1>=h;h++)for(var o=-1;1>=o;o++){var d=(a+4*h)*t.width+(i+4*o),n=this.getColourValue(t,d);s+=this.kernel[h+1][o+1]*n}e.data[a*t.width+i]=s,e.data[a*t.width+i+1]=s,e.data[a*t.width+i+2]=s,e.data[a*t.width+i+3]=255}return e},CLARITY.MotionDetector=function(t){this.frames=[],this.frameNo=1,this.index=0,this.preindex=this.frameNo,CLARITY.Filter.call(this,t)},CLARITY.MotionDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MotionDetector.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);if(this.pushFrame(t),this.frames.length<this.frameNo+1)return e;for(var a=0;a<t.width*t.height*4;a+=4)e.data[a+0]=Math.abs(this.getColourValue(this.frames[this.preindex],a)-this.getColourValue(this.frames[this.index],a)),e.data[a+1]=Math.abs(this.getColourValue(this.frames[this.preindex],a)-this.getColourValue(this.frames[this.index],a)),e.data[a+2]=Math.abs(this.getColourValue(this.frames[this.preindex],a)-this.getColourValue(this.frames[this.index],a)),e.data[a+3]=255;return e},CLARITY.MotionDetector.prototype.pushFrame=function(t){this.frames[this.index]=CLARITY.ctx.createImageData(t.width,t.height);for(var e=0;e<t.data.length;e++)this.frames[this.index].data[e]=t.data[e];this.index++,this.index>this.frameNo&&(this.index=0),this.preindex++,this.preindex>this.frameNo&&(this.preindex=0)},CLARITY.SkinDetector=function(t){var t=t||{};this.componentised=t.componentised||!1,CLARITY.Filter.call(this,t)},CLARITY.SkinDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.SkinDetector.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);this.RGBAtoYCbCr(e,t);for(var a=0;a<t.width*t.height*4;a+=4)this.componentised?(e.data[a+0]=e.data[a]>30?255:0,e.data[a+1]=80<e.data[a+1]&&e.data[a+1]<121?255:0,e.data[a+2]=133<e.data[a+2]&&e.data[a+2]<173?255:0):e.data[a]>30&&80<e.data[a+1]&&e.data[a+1]<121&&133<e.data[a+2]&&e.data[a+2]<173?(e.data[a+0]=255,e.data[a+1]=255,e.data[a+2]=255):(e.data[a+0]=0,e.data[a+1]=0,e.data[a+2]=0),e.data[a+3]=255;return e},CLARITY.SkinDetector.prototype.RGBAtoYCbCr=function(t,e){for(var a,i,r,s=0;s<e.width*e.height*4;s+=4)a=16+(66*e.data[s]+129*e.data[s+1]+25*e.data[s+2])/256,i=128+(-38*e.data[s]-74*e.data[s+1]+112*e.data[s+2])/256,r=128+(112*e.data[s]-94*e.data[s+1]-18*e.data[s+2])/256,t.data[s]=a,t.data[s+1]=i,t.data[s+2]=r},CLARITY.AverageThreshold=function(t){var t=t||{};this.inverted=t.inverted||!1,this.thresh=t.thresh||null,CLARITY.Filter.call(this,t)},CLARITY.AverageThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.AverageThreshold.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=this.thresh||this.getThresholdValue(t),i=0;i<t.width*t.height*4;i+=4){var r=this.getColourValue(t,i,this.channel);this.inverted?a>r?(e.data[i+0]=255,e.data[i+1]=255,e.data[i+2]=255):(e.data[i+0]=0,e.data[i+1]=0,e.data[i+2]=0):r>a?(e.data[i+0]=255,e.data[i+1]=255,e.data[i+2]=255):(e.data[i+0]=0,e.data[i+1]=0,e.data[i+2]=0),e.data[i+3]=255}return e},CLARITY.AverageThreshold.prototype.getThresholdValue=function(t){var e;e=this.getColourValue(t,0);for(var a=4;a<t.width*t.height*4;a+=4){var i=this.getColourValue(t,a);e=(e+i)/2}for(var r=0,s=0,h=0,o=e;!(h>o-1&&o+1>h);){h=o;for(var a=0;a<t.width*t.height*4;a+=4){var i=this.getColourValue(t,a);h>i?r=0==r?i:(r+i)/2:s=0==s?i:(s+i)/2}o=(s+r)/2,r=0,s=0}return o},CLARITY.GradientThreshold=function(t){var t=t||{};this.thresh=t.thresh||20,this.distance=t.distance||1,CLARITY.Filter.call(this,t)},CLARITY.GradientThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.GradientThreshold.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=!1,i=this.distance;i<t.height-this.distance;i++)for(var r=this.distance;r<t.width-this.distance;r++){a=!1;var s=4*(i*t.width+r),h=4*((i-this.distance)*t.width+r),o=4*((i+this.distance)*t.width+r),d=4*(i*t.width+(r-this.distance)),n=4*(i*t.width+(r+this.distance));t.data[s]<t.data[d]-this.thresh?a=!0:t.data[s]>t.data[d]+this.thresh?a=!0:t.data[s]<t.data[n]-this.thresh?a=!0:t.data[s]>t.data[n]+this.thresh?a=!0:t.data[s]<t.data[h]-this.thresh?a=!0:t.data[s]>t.data[h]+this.thresh?a=!0:t.data[s]<t.data[o]-this.thresh?a=!0:t.data[s]>t.data[o]+this.thresh&&(a=!0),a?(e.data[s+0]=255,e.data[s+1]=255,e.data[s+2]=255,e.data[s+3]=255):(e.data[s+0]=0,e.data[s+1]=0,e.data[s+2]=0,e.data[s+3]=255)}return e},CLARITY.MedianThreshold=function(t){CLARITY.Filter.call(this,t)},CLARITY.MedianThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MedianThreshold.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);this.threshes=this.getThresholdValues(t),this.threshes.push(256);for(var a=0;a<t.data.length;a++)if((a+1)%4!=0){for(var i=0;i<this.threshes.length;i++)if(t.data[a]<this.threshes[i]){e.data[a]=this.threshes[i];break}}else e.data[a]=255;return e},CLARITY.MedianThreshold.prototype.getThresholdValues=function(t){for(var e=new Array,a=[0,0,0],i=0;256>i;i++)e[i]=0;for(var i=0;i<t.data.length;i+=4)e[t.data[i]]++;for(var r=0,s=t.data.length/4/4,h=0,i=0;256>i;i++)r+=e[i],r>s&&(s+=t.data.length/4/4,a[h]=i,h++);return a},CLARITY.DifferenceDetector=function(t){var t=t||{};this.original=null,CLARITY.Filter.call(this,t)},CLARITY.DifferenceDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DifferenceDetector.prototype.process=function(t){if(!this.original)return this.original=t,t;for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.width*t.height*4;a+=4){var i=[this.original.data[a],this.original.data[a+1],this.original.data[a+2]],r=[t.data[a],t.data[a+1],t.data[a+2]];findDifference(r,i)?(e.data[a]=t.data[a],e.data[a+1]=t.data[a+1],e.data[a+2]=t.data[a+2],e.data[a+3]=255):(e.data[a]=0,e.data[a+1]=0,e.data[a+2]=0,e.data[a+3]=255)}return e},CLARITY.DifferenceDetector.prototype.resetOriginal=function(){this.original=null},CLARITY.DifferenceDetector.prototype.findDifference=function(t,e){return t[0]<e[0]+75&&t[0]>e[0]-75&&t[1]<e[1]+75&&t[1]>e[1]-75&&t[2]<e[2]+75&&t[2]>e[2]-75?!1:!0},CLARITY.Ghoster=function(t){var t=t||{};this.length=t.length||10,this.frames=new Array,CLARITY.Filter.call(this,t)},CLARITY.Ghoster.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Ghoster.prototype.process=function(t){this.frames.unshift(t),this.frames.length>this.length&&this.frames.pop();for(var e=CLARITY.ctx.createImageData(width,height),a=0;a<t.data.length;a+=4){for(var i=0;i<this.frames.length;i++)e.data[a]+=this.frames[i].data[a]/this.frames.length*(i/this.frames.length)*2,e.data[a+1]+=this.frames[i].data[a+1]/this.frames.length*(i/this.frames.length)*2,e.data[a+2]+=this.frames[i].data[a+2]/this.frames.length*(i/this.frames.length)*2;e.data[a+3]=255}return e},CLARITY.Puzzler=function(t){var t=t||{};this.width=t.width||640,this.height=t.height||480,this.selected=null,this.splits=t.splits||8,this.swaps=[];for(var e=0,a=0;a<this.splits;a++){this.swaps[a]=[];for(var i=0;i<this.splits;i++)this.swaps[a][i]=e++}for(var a=0;a<10*this.splits;a++){var r=Math.floor(Math.random()*this.splits),s=Math.floor(Math.random()*this.splits),h=Math.floor(Math.random()*this.splits),o=Math.floor(Math.random()*this.splits),d=this.swaps[r][s];this.swaps[r][s]=this.swaps[h][o],this.swaps[h][o]=d}CLARITY.Filter.call(this,t)},CLARITY.Puzzler.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Puzzler.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=this.height/this.splits,i=this.width/this.splits,r=0;r<this.splits;r++)for(var s=0;s<this.splits;s++)for(var h=this.numToPos(this.swaps[s][r]),o=0;a>o;o++)for(var d=0;i>d;d++){var n=4*((r*a+o)*t.width+(s*i+d)),c=4*((h[1]*a+o)*t.width+(h[0]*i+d)),l=this.getPixel(t.data,c);e.data[n]=l[0],e.data[n+1]=l[1],e.data[n+2]=l[2],e.data[n+3]=255}if(void 0!=this.selected)for(var r=0;r<this.height/this.splits;r++)for(var s=0;s<this.width/this.splits;s++){var n=4*((this.selected[1]*(this.height/this.splits)+r)*this.width+(this.selected[0]*(this.width/this.splits)+s));e.data[n+2]+=80}return e},CLARITY.Puzzler.prototype.getPixel=function(t,e){return[t[e],t[e+1],t[e+2]]},CLARITY.Puzzler.prototype.setPixel=function(t,e,a,i){var r=4*(a*this.width+e);t.data[r]=i[0],t.data[r+1]=i[1],t.data[r+2]=i[2]},CLARITY.Puzzler.prototype.setClick=function(t){var e=Math.floor(t[0]/(this.width/this.splits)),a=Math.floor(t[1]/(this.height/this.splits));if(this.selected){var i=this.swaps[this.selected[0]][this.selected[1]];this.swaps[this.selected[0]][this.selected[1]]=this.swaps[e][a],this.swaps[e][a]=i,this.selected=void 0}else this.selected=[e,a]},CLARITY.Puzzler.prototype.numToPos=function(t){for(var e=0,a=0;t>this.splits-1;)t-=this.splits,e++;return a=t,[e,a]};