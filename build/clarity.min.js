var CLARITY={ctx:document.createElement("canvas").getContext("2d")};CLARITY.Filter=function(t){var t=t||{};this.channel=t.channel||"grey"},CLARITY.Filter.prototype={process:function(t){return t},getColourValue:function(t,e,a){var a=a||this.channel||"grey";switch(a){case"grey":return.2989*t.data[e+0]+.587*t.data[e+1]+.114*t.data[e+2];case"red":case"r":return t.data[e+0];case"green":case"g":return t.data[e+1];case"blue":case"b":return t.data[e+2];default:return.2989*t.data[e+0]+.587*t.data[e+1]+.114*t.data[e+2]}}},CLARITY.MCut=function(){function t(){function e(){var t,e=[{min:Number.MAX_VALUE,max:Number.MIN_VALUE},{min:Number.MAX_VALUE,max:Number.MIN_VALUE},{min:Number.MAX_VALUE,max:Number.MIN_VALUE}];for(t=f.length-1;t>=0;t-=1)e[0].min=f[t][0]<e[0].min?f[t][0]:e[0].min,e[1].min=f[t][1]<e[1].min?f[t][1]:e[1].min,e[2].min=f[t][2]<e[2].min?f[t][2]:e[2].min,e[0].max=f[t][0]>e[0].max?f[t][0]:e[0].max,e[1].max=f[t][1]>e[1].max?f[t][1]:e[1].max,e[2].max=f[t][2]>e[2].max?f[t][2]:e[2].max;return e}function a(t){f=t,C=3,g=e()}function r(){return f}function i(){var t,e,a=0,r=0;for(t=C-1;t>=0;t-=1)e=g[t].max-g[t].min,e>r&&(a=t,r=e);return{axis:a,length:r}}function s(t){var e=function(e,a){return e[t]-a[t]};return e}function h(){var t=i().axis,e=s(t);return Array.prototype.sort.call(f,e),f}function o(){var t,e,a,r=0,s=Number.MAX_VALUE,h=i().axis;for(a=f.length-1;a>=0;a-=1)r+=f[a][h];for(r/=f.length,a=f.length-1;a>=0;a-=1)e=Math.abs(f[a][h]-r),s>e&&(s=e,t=a);return t}function n(){h();var e=o(),a=Array.prototype.slice.call(f,0,e),r=Array.prototype.slice.call(f,e),i=new t,s=new t;return i.init(a),s.init(r),[i,s]}function d(){var t,e=0,a=0,r=0;for(t=f.length-1;t>=0;t-=1)e+=f[t][0],a+=f[t][1],r+=f[t][2];return e/=f.length,a/=f.length,r/=f.length,[parseInt(e,10),parseInt(a,10),parseInt(r,10)]}function c(){return Math.floor(f.length/2)}function l(){return 0===f.length}function u(){return f.length>=2}function p(){return g}var f,g,C;return{get_data:r,median_pos:c,get_bounding_box:p,calculate_bounding_box:e,sort:h,get_comparison_func:s,mean_pos:o,split:n,is_empty:l,is_splittable:u,get_longest_axis:i,average:d,init:a}}function e(){"use strict";function e(e){var r=!1;if(a(e)){var i=new t;i.init(e),n=[i],r=!0}return r}function a(t){var e=t.length>0;return e}function r(t){var a=e(t);a&&(d=t)}function i(){var t,e=0;for(t=n.length-1;t>=0;t-=1)n[t]>e&&(e=n[t]);return e}function s(){return n}function h(t){var a,r,s,h,o,c,l,u,p,f;if(e(d),0===n.length)return[];r=[],h=i(),o=n[h].get_longest_axis(),c=o.length*(1-t);do l=n.splice(h,1)[0],u=l.split(),p=u[0],f=u[1],n.push(p),n.push(f),h=i(),o=n[h].get_longest_axis();while(o.length>c);for(s=0;s<n.length;s+=1)a=n[s].average(),isNaN(a[0])&&isNaN(a[0])&&isNaN(a[0])||r.push(n[s].average());return r}function o(t){var a,r,s,h,o=[];if(e(d),0===n.length)return[];for(a=t-1;a>=0;a-=1)r=i(),s=n.splice(r,1)[0],s.is_splittable()?(h=s.split(),n.push(h[0]),n.push(h[1])):(n.push(s),n.push(s));for(a=t-1;a>=0;a-=1)o.push(n[a].average());return o}var n=[],d=[];return{get_boxes:s,init:r,get_fixed_size_palette:o,get_dynamic_size_palette:h}}this.MCut=new e},CLARITY.Operations={RGBtoHSV:function(t){var e,a,r,i;e=t[0]/255,a=t[1]/255,r=t[2]/255;var s=this.minimum([e,a,r]),h=this.maximum([e,a,r]);if(s==h)return computedV=s,[0,0,computedV];var o=e==s?a-r:r==s?e-a:r-e,i=e==s?3:r==s?1:5;return computedH=60*(i-o/(h-s)),computedS=(h-s)/h,computedV=h,[computedH,computedS,computedV]},HSVtoRGB:function(t){var e,a,r,i;a=t[0],r=t[1],i=t[2];var e=a/60,s=i*r,h=s*(1-Math.abs(e%2-1)),o=i-s;switch(e=Math.floor(e)){case 0:case 6:return[255*(s+o),255*(h+o),255*(0+o)];case 1:return[255*(h+o),255*(s+o),255*(0+o)];case 2:return[255*(0+o),255*(s+o),255*(h+o)];case 3:return[255*(0+o),255*(h+o),255*(s+o)];case 4:return[255*(h+o),255*(0+o),255*(s+o)];default:return[255*(s+o),255*(0+o),255*(h+o)]}},minimum:function(t){for(var e=256,a=0;a<t.length;a++)t[a]<e&&(e=t[a]);return e},maximum:function(t){for(var e=0,a=0;a<t.length;a++)t[a]>e&&(e=t[a]);return e},clamp:function(t,e,a){return e>t?e:t>a?a:t},colorDistance:function(t,e){this.colourDistance(t,e)},colourDistance:function(t,e){return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2)}},CLARITY.Pixel=function(t,e,a){this.r=0,this.g=0,this.b=0,this.h=0,this.s=0,this.v=0,this.setFromRGB(t,e,a)},CLARITY.Pixel.prototype={getColourValue:function(t){var t=this.channel||t||"grey";switch(t){case"grey":return.2989*this.r+.587*this.g+.114*this.b;case"red":case"r":return this.r;case"green":case"g":return this.g;case"blue":case"b":return this.b;case"hue":case"h":return this.h;case"saturation":case"s":return this.s;case"value":case"v":return this.v;default:return.2989*this.r+.587*this.g+.114*this.b}},setFromRGB:function(t,e,a){var r,i,s;return this.r=t,this.g=e,this.b=a,r=minimum([this.r,this.g,this.b]),i=maximum([this.r,this.g,this.b]),this.v=i,s=i-r,0==i?(this.s=0,void(this.h=-1)):(this.s=s/i,this.h=this.r==i?(this.g-this.b)/s:this.g==i?2+(this.b-this.r)/s:4+(this.r-this.g)/s,this.h*=60,void(this.h<0&&(this.h+=360)))},setFromHSV:function(t,e,a){var r,i,s,h,o;if(this.h=t,this.s=e,this.v=a,0==this.s)return void(this.r=this.g=this.b=this.v);switch(r=Math.floor(this.h/60),i=this.h-r,s=this.v*(1-this.s),h=this.v*(1-this.s*i),o=this.v*(1-this.s*(1-i)),r){case 0:this.r=a,this.g=o,this.b=s;break;case 1:this.r=h,this.g=a,this.b=s;break;case 2:this.r=s,this.g=a,this.b=o;break;case 3:this.r=s,this.g=h,this.b=a;break;case 4:this.r=o,this.g=s,this.b=a;break;default:this.r=a,this.g=s,this.b=h}}},CLARITY.Contourer=function(t){var t=t||{};this.contours=t.contours||10,this.threshes=[128,256],this.threshSets=[0,256],this.difference=128,this.maxValue=0,this.minValue=255,CLARITY.Filter.call(this,t)},CLARITY.Contourer.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Contourer.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.data.length;a+=4)t.data[a]>this.maxValue?this.maxValue=t.data[a]:t.data[a]<this.minValue&&(this.minValue=t.data[a]);this.setVar(this.contours);for(var a=0;a<t.data.length;a++)if((a+1)%4!=0){for(var r=0;r<this.threshes.length;r++)if(t.data[a]<this.threshes[r]){e.data[a]=this.threshSets[r];break}}else e.data[a]=255;return e},CLARITY.Contourer.prototype.setVar=function(t){this.threshes=[],this.difference=(this.maxValue-this.minValue)/t;for(var e=0,a=this.difference+this.minValue;256>=a;a+=this.difference)this.threshes[e]=a,this.threshSets[e]=(a-this.difference-this.minValue)/(this.maxValue-this.minValue)*255,e++;this.threshes[e]=a,this.threshSets[e]=255},CLARITY.NormalEditor=function(t){var t=t||{};this.intensity=t.intensity||.5,CLARITY.Filter.call(this,t)},CLARITY.NormalEditor.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.NormalEditor.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=1;a<t.height-1;a++)for(var r=1;r<t.width-1;r++){var i=4*(a*t.width+r),s={x:(t.data[i]-128)/128,y:(t.data[i+1]-128)/128,z:t.data[i+2]/255};s=this.normalise(s),s.x*=this.intensity,s.y*=this.intensity,s=this.normalise(s),e.data[i]=128*(s.x+1),e.data[i+1]=128*(s.y+1),e.data[i+2]=255*s.z,e.data[i+3]=255}return e},CLARITY.NormalEditor.prototype.normalise=function(t){var e=Math.sqrt(Math.abs(t.x*t.x+t.y*t.y+t.z*t.z));return{x:t.x/e,y:t.y/e,z:t.z/e}},CLARITY.NormalGenerator=function(t){var t=t||{};this.heightMod=t.heightMod||.15,CLARITY.Filter.call(this,t)},CLARITY.NormalGenerator.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.NormalGenerator.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=1;a<t.height-1;a++)for(var r=1;r<t.width-1;r++){var i=4*(a*t.width+r),s=4*((a-1)*t.width+r),h=4*((a+1)*t.width+r),o=4*(a*t.width+(r-1)),n=4*(a*t.width+(r+1)),d={x:r,y:a,z:this.heightMod*t.data[i]},c={x:r,y:a-1,z:this.heightMod*t.data[s]},l={x:r,y:a+1,z:this.heightMod*t.data[h]},u={x:r-1,y:a,z:this.heightMod*t.data[o]},p={x:r+1,y:a,z:this.heightMod*t.data[n]},f=this.generateNormal(d,u,p,c,l);e.data[i]=255-(f.x/2+128),e.data[i+1]=255-(f.y/2+128),e.data[i+2]=-f.z,e.data[i+3]=255}return e},CLARITY.NormalGenerator.prototype.generateNormal=function(t,e,a,r,i){var s=this.calcNormal(t,r,e),h=this.calcNormal(t,e,i),o=this.calcNormal(t,i,a),n=this.calcNormal(t,a,r),d=this.average(s,h,o,n);return d},CLARITY.NormalGenerator.prototype.calcNormal=function(t,e,a){var r=this.vectorSub(t,e),i=this.vectorSub(t,a),s=this.crossProduct(r,i);return s=this.normalise(s)},CLARITY.NormalGenerator.prototype.vectorSub=function(t,e){return{x:t.x-e.x,y:t.y-e.y,z:t.z-e.z}},CLARITY.NormalGenerator.prototype.vectorAdd=function(t,e){return{x:t.x+e.x,y:t.y+e.y,z:t.z+e.z}},CLARITY.NormalGenerator.prototype.crossProduct=function(t,e){return{x:t.y*e.z-t.z*e.y,y:-(t.x*e.z-t.z*e.x),z:t.x*e.y-t.y*e.x}},CLARITY.NormalGenerator.prototype.normalise=function(t){var e=Math.sqrt(Math.abs(t.x*t.x+t.y*t.y+t.z*t.z));return{x:t.x/e,y:t.y/e,z:t.z/e}},CLARITY.NormalGenerator.prototype.average=function(t,e,a,r){var i=this.vectorAdd(t,e);return i=this.vectorAdd(i,a),i=this.vectorAdd(i,r),i=this.normalise(i),{x:255*i.x,y:255*i.y,z:255*i.z}},CLARITY.Desaturate=function(t){var t=t||{};CLARITY.Filter.call(this,t)},CLARITY.Desaturate.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Desaturate.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.width*t.height*4;a+=4){var r=this.getColourValue(t,a,"grey");e.data[a+0]=r,e.data[a+1]=r,e.data[a+2]=r,e.data[a+3]=255}return e},CLARITY.DotRemover=function(t){var t=t||{};this.neighboursReq=t.neighboursReq||1,CLARITY.Filter.call(this,t)},CLARITY.DotRemover.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DotRemover.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=1;a<t.height-1;a++)for(var r=1;r<t.width-1;r++){var i=4*(a*t.width+r),s=4*((a-1)*t.width+r),h=4*((a+1)*t.width+r),o=4*(a*t.width+(r-1)),n=4*(a*t.width+(r+1)),d=t.data[i],c=0;t.data[s]==d&&c++,t.data[h]==d&&c++,t.data[o]==d&&c++,t.data[n]==d&&c++,c<=this.neighboursReq?d>138?(e.data[i]=0,e.data[i+1]=0,e.data[i+2]=0):(e.data[i]=255,e.data[i+1]=255,e.data[i+2]=255):(e.data[i]=d,e.data[i+1]=d,e.data[i+2]=d),e.data[i+3]=255}return e},CLARITY.hsvShifter=function(t){var t=t||{};this.hue=t.hue||0,this.saturation=t.saturation||1,this.value=t.value||t.lightness||1,CLARITY.Filter.call(this,t)},CLARITY.hsvShifter.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.hsvShifter.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.width*t.height*4;a+=4){var r=CLARITY.Operations.RGBtoHSV([t.data[a],t.data[a+1],t.data[a+2]]);r[0]+=this.hue,r[0]>360&&(r[0]-=360),r[1]*=this.saturation,r[2]*=this.value,r=CLARITY.Operations.HSVtoRGB([r[0],r[1],r[2]]),e.data[a+0]=r[0],e.data[a+1]=r[1],e.data[a+2]=r[2],e.data[a+3]=255}return e},CLARITY.Posteriser=function(t){var t=t||{};this.method=t.method,"fast"==this.method?(this.threshes=[128,256],this.difference=32,this.setThresh(64)):(this.colourCount=t.colourCount||5,this.MCut=(new CLARITY.MCut).MCut),CLARITY.Filter.call(this,t)},CLARITY.Posteriser.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Posteriser.prototype.process=function(t){if("fast"==this.method)return this.oldMethod(t);for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=[],r=0;r<t.data.length;r+=4)a.push([t.data[r],t.data[r+1],t.data[r+2]]);this.MCut.init(a);for(var i,s,h=this.MCut.get_fixed_size_palette(this.colourCount),r=0;r<t.data.length;r+=4){var o,n=[t.data[r],t.data[r+1],t.data[r+2]];if(s&&i+5>o&&o>i-5)o=CLARITY.Operations.colourDistance(n,s),d=s;else{for(var d=h[0],c=CLARITY.Operations.colourDistance(n,d),l=1;l<h.length;l++)o=CLARITY.Operations.colourDistance(n,h[l]),c>o&&(c=o,d=h[l]);s=d,i=c}e.data[r]=d[0],e.data[r+1]=d[1],e.data[r+2]=d[2],e.data[r+3]=255}return e},CLARITY.Posteriser.prototype.oldMethod=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.data.length;a+=4)if((a+1)%4!=0){for(var r=0;r<this.threshes.length;r++)if(t.data[a]<this.threshes[r]){e.data[a]=this.threshes[r]-this.difference/2;break}}else e.data[a]=255;return e},CLARITY.Posteriser.prototype.setThresh=function(t){this.threshes=[],this.difference=t;for(var e=0,a=this.difference;256>=a;a+=this.difference)this.threshes[e]=a,e++;this.threshes[e]=a},CLARITY.Sharpen=function(t){var t=t||{};this.channel=t.channel||"grey",this.intensity=t.intensity||1,this.kernel=[[-this.intensity,-this.intensity,-this.intensity],[-this.intensity,8*this.intensity+1,-this.intensity],[-this.intensity,-this.intensity,-this.intensity]],CLARITY.Filter.call(this,t)},CLARITY.Sharpen.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Sharpen.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=4;a<4*t.height-4;a+=4)for(var r=4;r<4*t.width-4;r+=4){for(var i=0,s=0,h=0,o=-1;1>=o;o++)for(var n=-1;1>=n;n++){var d=(a+4*o)*t.width+(r+4*n),c=this.getColourValue(t,d,"red"),l=this.getColourValue(t,d,"green"),u=this.getColourValue(t,d,"blue");i+=this.kernel[o+1][n+1]*c,s+=this.kernel[o+1][n+1]*l,h+=this.kernel[o+1][n+1]*u}e.data[a*t.width+r]=i,e.data[a*t.width+r+1]=s,e.data[a*t.width+r+2]=h,e.data[a*t.width+r+3]=255}return e},CLARITY.Smoother=function(t){var t=t||{};this.distance=t.distance||1,this.iterations=t.iterations||1,CLARITY.Filter.call(this,t)},CLARITY.Smoother.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Smoother.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<this.iterations;a++)for(var r=this.distance;r<t.height-this.distance;r++)for(var i=this.distance;i<t.width-this.distance;i++){var s=4*(r*t.width+i),h=4*((r-this.distance)*t.width+i),o=4*((r+this.distance)*t.width+i),n=4*(r*t.width+(i-this.distance)),d=4*(r*t.width+(i+this.distance));e.data[s+0]=(t.data[n+0]+t.data[d+0]+t.data[h+0]+t.data[o+0])/4,e.data[s+1]=(t.data[n+1]+t.data[d+1]+t.data[h+1]+t.data[o+1])/4,e.data[s+2]=(t.data[n+2]+t.data[d+2]+t.data[h+2]+t.data[o+2])/4,e.data[s+3]=255}return e},CLARITY.EdgeDetector=function(t){var t=t||{};this.fast=t.fast||!1,this.channel=t.channel||"grey",this.kernel=[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],CLARITY.Filter.call(this,t)},CLARITY.EdgeDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.EdgeDetector.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);if(this.fast)for(var a=4;a<4*t.height-4;a+=4)for(var r=4;r<4*t.width-4;r+=4){var i=a*t.width+r;e.data[i]=5*Math.abs(this.getColourValue(t,i+4)-this.getColourValue(t,i)),e.data[i+1]=5*Math.abs(this.getColourValue(t,i+4)-this.getColourValue(t,i)),e.data[i+2]=5*Math.abs(this.getColourValue(t,i+4)-this.getColourValue(t,i)),e.data[i+3]=255}else for(var a=4;a<4*t.height-4;a+=4)for(var r=4;r<4*t.width-4;r+=4){for(var s=0,h=-1;1>=h;h++)for(var o=-1;1>=o;o++){var n=(a+4*h)*t.width+(r+4*o),d=this.getColourValue(t,n);s+=this.kernel[h+1][o+1]*d}e.data[a*t.width+r]=s,e.data[a*t.width+r+1]=s,e.data[a*t.width+r+2]=s,e.data[a*t.width+r+3]=255}return e},CLARITY.MotionDetector=function(t){this.frames=[],this.frameNo=1,this.index=0,this.preindex=this.frameNo,CLARITY.Filter.call(this,t)},CLARITY.MotionDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MotionDetector.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);if(this.pushFrame(t),this.frames.length<this.frameNo+1)return e;for(var a=0;a<t.width*t.height*4;a+=4)e.data[a+0]=Math.abs(this.getColourValue(this.frames[this.preindex],a)-this.getColourValue(this.frames[this.index],a)),e.data[a+1]=Math.abs(this.getColourValue(this.frames[this.preindex],a)-this.getColourValue(this.frames[this.index],a)),e.data[a+2]=Math.abs(this.getColourValue(this.frames[this.preindex],a)-this.getColourValue(this.frames[this.index],a)),e.data[a+3]=255;return e},CLARITY.MotionDetector.prototype.pushFrame=function(t){this.frames[this.index]=CLARITY.ctx.createImageData(t.width,t.height);for(var e=0;e<t.data.length;e++)this.frames[this.index].data[e]=t.data[e];this.index++,this.index>this.frameNo&&(this.index=0),this.preindex++,this.preindex>this.frameNo&&(this.preindex=0)},CLARITY.SkinDetector=function(t){var t=t||{};this.componentised=t.componentised||!1,CLARITY.Filter.call(this,t)},CLARITY.SkinDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.SkinDetector.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);this.RGBAtoYCbCr(e,t);for(var a=0;a<t.width*t.height*4;a+=4)this.componentised?(e.data[a+0]=e.data[a]>30?255:0,e.data[a+1]=80<e.data[a+1]&&e.data[a+1]<121?255:0,e.data[a+2]=133<e.data[a+2]&&e.data[a+2]<173?255:0):e.data[a]>30&&80<e.data[a+1]&&e.data[a+1]<121&&133<e.data[a+2]&&e.data[a+2]<173?(e.data[a+0]=255,e.data[a+1]=255,e.data[a+2]=255):(e.data[a+0]=0,e.data[a+1]=0,e.data[a+2]=0),e.data[a+3]=255;return e},CLARITY.SkinDetector.prototype.RGBAtoYCbCr=function(t,e){for(var a,r,i,s=0;s<e.width*e.height*4;s+=4)a=16+(66*e.data[s]+129*e.data[s+1]+25*e.data[s+2])/256,r=128+(-38*e.data[s]-74*e.data[s+1]+112*e.data[s+2])/256,i=128+(112*e.data[s]-94*e.data[s+1]-18*e.data[s+2])/256,t.data[s]=a,t.data[s+1]=r,t.data[s+2]=i},CLARITY.AverageThreshold=function(t){var t=t||{};this.inverted=t.inverted||!1,this.thresh=t.thresh||null,CLARITY.Filter.call(this,t)},CLARITY.AverageThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.AverageThreshold.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=this.thresh||this.getThresholdValue(t),r=0;r<t.width*t.height*4;r+=4){var i=this.getColourValue(t,r,this.channel);this.inverted?a>i?(e.data[r+0]=255,e.data[r+1]=255,e.data[r+2]=255):(e.data[r+0]=0,e.data[r+1]=0,e.data[r+2]=0):i>a?(e.data[r+0]=255,e.data[r+1]=255,e.data[r+2]=255):(e.data[r+0]=0,e.data[r+1]=0,e.data[r+2]=0),e.data[r+3]=255}return e},CLARITY.AverageThreshold.prototype.getThresholdValue=function(t){var e;e=this.getColourValue(t,0);for(var a=4;a<t.width*t.height*4;a+=4){var r=this.getColourValue(t,a);e=(e+r)/2}for(var i=0,s=0,h=0,o=e;!(h>o-1&&o+1>h);){h=o;for(var a=0;a<t.width*t.height*4;a+=4){var r=this.getColourValue(t,a);h>r?i=0==i?r:(i+r)/2:s=0==s?r:(s+r)/2}o=(s+i)/2,i=0,s=0}return o},CLARITY.GradientThreshold=function(t){var t=t||{};this.thresh=t.thresh||20,this.distance=t.distance||1,CLARITY.Filter.call(this,t)},CLARITY.GradientThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.GradientThreshold.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=!1,r=this.distance;r<t.height-this.distance;r++)for(var i=this.distance;i<t.width-this.distance;i++){a=!1;var s=4*(r*t.width+i),h=4*((r-this.distance)*t.width+i),o=4*((r+this.distance)*t.width+i),n=4*(r*t.width+(i-this.distance)),d=4*(r*t.width+(i+this.distance));t.data[s]<t.data[n]-this.thresh?a=!0:t.data[s]>t.data[n]+this.thresh?a=!0:t.data[s]<t.data[d]-this.thresh?a=!0:t.data[s]>t.data[d]+this.thresh?a=!0:t.data[s]<t.data[h]-this.thresh?a=!0:t.data[s]>t.data[h]+this.thresh?a=!0:t.data[s]<t.data[o]-this.thresh?a=!0:t.data[s]>t.data[o]+this.thresh&&(a=!0),a?(e.data[s+0]=255,e.data[s+1]=255,e.data[s+2]=255,e.data[s+3]=255):(e.data[s+0]=0,e.data[s+1]=0,e.data[s+2]=0,e.data[s+3]=255)}return e},CLARITY.MedianThreshold=function(t){CLARITY.Filter.call(this,t)},CLARITY.MedianThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MedianThreshold.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);this.threshes=this.getThresholdValues(t),this.threshes.push(256);for(var a=0;a<t.data.length;a++)if((a+1)%4!=0){for(var r=0;r<this.threshes.length;r++)if(t.data[a]<this.threshes[r]){e.data[a]=this.threshes[r];break}}else e.data[a]=255;return e},CLARITY.MedianThreshold.prototype.getThresholdValues=function(t){for(var e=new Array,a=[0,0,0],r=0;256>r;r++)e[r]=0;for(var r=0;r<t.data.length;r+=4)e[t.data[r]]++;for(var i=0,s=t.data.length/4/4,h=0,r=0;256>r;r++)i+=e[r],i>s&&(s+=t.data.length/4/4,a[h]=r,h++);return a},CLARITY.DifferenceDetector=function(t){var t=t||{};this.original=null,CLARITY.Filter.call(this,t)},CLARITY.DifferenceDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DifferenceDetector.prototype.process=function(t){if(!this.original)return this.original=t,t;for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.width*t.height*4;a+=4){var r=[this.original.data[a],this.original.data[a+1],this.original.data[a+2]],i=[t.data[a],t.data[a+1],t.data[a+2]];findDifference(i,r)?(e.data[a]=t.data[a],e.data[a+1]=t.data[a+1],e.data[a+2]=t.data[a+2],e.data[a+3]=255):(e.data[a]=0,e.data[a+1]=0,e.data[a+2]=0,e.data[a+3]=255)}return e},CLARITY.DifferenceDetector.prototype.resetOriginal=function(){this.original=null},CLARITY.DifferenceDetector.prototype.findDifference=function(t,e){return t[0]<e[0]+75&&t[0]>e[0]-75&&t[1]<e[1]+75&&t[1]>e[1]-75&&t[2]<e[2]+75&&t[2]>e[2]-75?!1:!0},CLARITY.Ghoster=function(t){var t=t||{};this.length=t.length||10,this.frames=new Array,CLARITY.Filter.call(this,t)},CLARITY.Ghoster.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Ghoster.prototype.process=function(t){this.frames.unshift(t),this.frames.length>this.length&&this.frames.pop();for(var e=CLARITY.ctx.createImageData(width,height),a=0;a<t.data.length;a+=4){for(var r=0;r<this.frames.length;r++)e.data[a]+=this.frames[r].data[a]/this.frames.length*(r/this.frames.length)*2,e.data[a+1]+=this.frames[r].data[a+1]/this.frames.length*(r/this.frames.length)*2,e.data[a+2]+=this.frames[r].data[a+2]/this.frames.length*(r/this.frames.length)*2;e.data[a+3]=255}return e},CLARITY.Puzzler=function(t){var t=t||{};this.width=t.width||640,this.height=t.height||480,this.selected=null,this.splits=t.splits||8,this.swaps=[];for(var e=0,a=0;a<this.splits;a++){this.swaps[a]=[];for(var r=0;r<this.splits;r++)this.swaps[a][r]=e++}for(var a=0;a<10*this.splits;a++){var i=Math.floor(Math.random()*this.splits),s=Math.floor(Math.random()*this.splits),h=Math.floor(Math.random()*this.splits),o=Math.floor(Math.random()*this.splits),n=this.swaps[i][s];this.swaps[i][s]=this.swaps[h][o],this.swaps[h][o]=n}CLARITY.Filter.call(this,t)},CLARITY.Puzzler.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Puzzler.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),a=this.height/this.splits,r=this.width/this.splits,i=0;i<this.splits;i++)for(var s=0;s<this.splits;s++)for(var h=this.numToPos(this.swaps[s][i]),o=0;a>o;o++)for(var n=0;r>n;n++){var d=4*((i*a+o)*t.width+(s*r+n)),c=4*((h[1]*a+o)*t.width+(h[0]*r+n)),l=this.getPixel(t.data,c);e.data[d]=l[0],e.data[d+1]=l[1],e.data[d+2]=l[2],e.data[d+3]=255}if(void 0!=this.selected)for(var i=0;i<this.height/this.splits;i++)for(var s=0;s<this.width/this.splits;s++){var d=4*((this.selected[1]*(this.height/this.splits)+i)*this.width+(this.selected[0]*(this.width/this.splits)+s));e.data[d+2]+=80}return e},CLARITY.Puzzler.prototype.getPixel=function(t,e){return[t[e],t[e+1],t[e+2]]},CLARITY.Puzzler.prototype.setPixel=function(t,e,a,r){var i=4*(a*this.width+e);t.data[i]=r[0],t.data[i+1]=r[1],t.data[i+2]=r[2]},CLARITY.Puzzler.prototype.setClick=function(t){var e=Math.floor(t[0]/(this.width/this.splits)),a=Math.floor(t[1]/(this.height/this.splits));if(this.selected){var r=this.swaps[this.selected[0]][this.selected[1]];this.swaps[this.selected[0]][this.selected[1]]=this.swaps[e][a],this.swaps[e][a]=r,this.selected=void 0}else this.selected=[e,a]},CLARITY.Puzzler.prototype.numToPos=function(t){for(var e=0,a=0;t>this.splits-1;)t-=this.splits,e++;return a=t,[e,a]};