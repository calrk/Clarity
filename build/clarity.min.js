var CLARITY={ctx:document.createElement("canvas").getContext("2d")};CLARITY.Filter=function(t){var t=t||{};this.channel=t.channel||"grey",this.enabled=t.enabled===!1?!1:!0},CLARITY.Filter.prototype={process:function(t){return this.enabled?t.length?this.doProcess(t[0],t[1]):this.doProcess(t):t},doProcess:function(t){return t},getColourValue:function(t,e,r){var r=r||this.channel||"grey";switch(r){case"grey":return.2989*t.data[e+0]+.587*t.data[e+1]+.114*t.data[e+2];case"red":case"r":return t.data[e+0];case"green":case"g":return t.data[e+1];case"blue":case"b":return t.data[e+2];default:return.2989*t.data[e+0]+.587*t.data[e+1]+.114*t.data[e+2]}},setFloat:function(t,e){this.properties[t]=parseFloat(e)},setInt:function(t,e){this.properties[t]=parseInt(e)},toggleBool:function(t){this.properties[t]=!this.properties[t]},toggleEnabled:function(){this.enabled=!this.enabled}},CLARITY.Filter.prototype.createControls=function(t){var e=this,r=CLARITY.Interface.createControlGroup(t,this.enabled);r.getElementsByTagName("input")[0].addEventListener("change",function(){e.toggleEnabled()});var a=this.doCreateControls();return r.appendChild(a),r},CLARITY.Filter.prototype.doCreateControls=function(){return label=CLARITY.Interface.createLabel("No options.")},CLARITY.MCut=function(){function t(){function e(){var t,e=[{min:Number.MAX_VALUE,max:Number.MIN_VALUE},{min:Number.MAX_VALUE,max:Number.MIN_VALUE},{min:Number.MAX_VALUE,max:Number.MIN_VALUE}];for(t=f.length-1;t>=0;t-=1)e[0].min=f[t][0]<e[0].min?f[t][0]:e[0].min,e[1].min=f[t][1]<e[1].min?f[t][1]:e[1].min,e[2].min=f[t][2]<e[2].min?f[t][2]:e[2].min,e[0].max=f[t][0]>e[0].max?f[t][0]:e[0].max,e[1].max=f[t][1]>e[1].max?f[t][1]:e[1].max,e[2].max=f[t][2]>e[2].max?f[t][2]:e[2].max;return e}function r(t){f=t,I=3,C=e()}function a(){return f}function i(){var t,e,r=0,a=0;for(t=I-1;t>=0;t-=1)e=C[t].max-C[t].min,e>a&&(r=t,a=e);return{axis:r,length:a}}function o(t){var e=function(e,r){return e[t]-r[t]};return e}function s(){var t=i().axis,e=o(t);return Array.prototype.sort.call(f,e),f}function n(){var t,e,r,a=0,o=Number.MAX_VALUE,s=i().axis;for(r=f.length-1;r>=0;r-=1)a+=f[r][s];for(a/=f.length,r=f.length-1;r>=0;r-=1)e=Math.abs(f[r][s]-a),o>e&&(o=e,t=r);return t}function h(){s();var e=n(),r=Array.prototype.slice.call(f,0,e),a=Array.prototype.slice.call(f,e),i=new t,o=new t;return i.init(r),o.init(a),[i,o]}function d(){var t,e=0,r=0,a=0;for(t=f.length-1;t>=0;t-=1)e+=f[t][0],r+=f[t][1],a+=f[t][2];return e/=f.length,r/=f.length,a/=f.length,[parseInt(e,10),parseInt(r,10),parseInt(a,10)]}function l(){return Math.floor(f.length/2)}function c(){return 0===f.length}function p(){return f.length>=2}function u(){return C}var f,C,I;return{get_data:a,median_pos:l,get_bounding_box:u,calculate_bounding_box:e,sort:s,get_comparison_func:o,mean_pos:n,split:h,is_empty:c,is_splittable:p,get_longest_axis:i,average:d,init:r}}function e(){"use strict";function e(e){var a=!1;if(r(e)){var i=new t;i.init(e),h=[i],a=!0}return a}function r(t){var e=t.length>0;return e}function a(t){var r=e(t);r&&(d=t)}function i(){var t,e=0;for(t=h.length-1;t>=0;t-=1)h[t]>e&&(e=h[t]);return e}function o(){return h}function s(t){var r,a,o,s,n,l,c,p,u,f;if(e(d),0===h.length)return[];a=[],s=i(),n=h[s].get_longest_axis(),l=n.length*(1-t);do c=h.splice(s,1)[0],p=c.split(),u=p[0],f=p[1],h.push(u),h.push(f),s=i(),n=h[s].get_longest_axis();while(n.length>l);for(o=0;o<h.length;o+=1)r=h[o].average(),isNaN(r[0])&&isNaN(r[0])&&isNaN(r[0])||a.push(h[o].average());return a}function n(t){var r,a,o,s,n=[];if(e(d),0===h.length)return[];for(r=t-1;r>=0;r-=1)a=i(),o=h.splice(a,1)[0],o.is_splittable()?(s=o.split(),h.push(s[0]),h.push(s[1])):(h.push(o),h.push(o));for(r=t-1;r>=0;r-=1)n.push(h[r].average());return n}var h=[],d=[];return{get_boxes:o,init:a,get_fixed_size_palette:n,get_dynamic_size_palette:s}}this.MCut=new e},CLARITY.Interface={createControlGroup:function(t,e){var r=document.createElement("div");r.setAttribute("class","clarity-controlGroup");var a;a=document.createElement("h3"),a.setAttribute("class","clarity-title"),a.innerHTML=t||"Clarity Filter",r.appendChild(a);var i=document.createElement("input");return i.setAttribute("class","clarity-checkbox"),i.setAttribute("type","checkbox"),e&&i.setAttribute("checked",e||!1),a.appendChild(i),r},createSlider:function(t,e,r,a,i){var o=document.createElement("div");o.setAttribute("class","clarity-control");var s=document.createElement("input");if(s.setAttribute("class","clarity-slider"),s.setAttribute("type","range"),s.setAttribute("min",t||0),s.setAttribute("max",e||1),s.setAttribute("step",r||1),i&&s.setAttribute("value",i),a){var n=document.createElement("label");n.setAttribute("class","clarity-label"),n.innerHTML=a,o.appendChild(n)}return o.appendChild(s),o},createToggle:function(t,e){var r=document.createElement("div");r.setAttribute("class","clarity-control");var a=document.createElement("input");if(a.setAttribute("class","clarity-checkbox"),a.setAttribute("type","checkbox"),e&&a.setAttribute("checked",!0),t){var i=document.createElement("label");i.setAttribute("class","clarity-label"),i.innerHTML=t,r.appendChild(i)}return r.appendChild(a),r},createBreak:function(){var t=document.createElement("br");return t},createDiv:function(){var t=document.createElement("div");return t},createLabel:function(t){var e=document.createElement("div");e.setAttribute("class","clarity-control");var r=document.createElement("label");return r.setAttribute("class","clarity-label"),r.innerHTML=t,e.appendChild(r),e}},CLARITY.Operations={RGBtoHSV:function(t){var e,r,a,i;e=t[0]/255,r=t[1]/255,a=t[2]/255;var o=this.minimum([e,r,a]),s=this.maximum([e,r,a]);if(o==s)return computedV=o,[0,0,computedV];var n=e==o?r-a:a==o?e-r:a-e,i=e==o?3:a==o?1:5;return computedH=60*(i-n/(s-o)),computedS=(s-o)/s,computedV=s,[computedH,computedS,computedV]},HSVtoRGB:function(t){var e,r,a,i;r=t[0],a=t[1],i=t[2];var e=r/60,o=i*a,s=o*(1-Math.abs(e%2-1)),n=i-o;switch(e=Math.floor(e)){case 0:case 6:return[255*(o+n),255*(s+n),255*n];case 1:return[255*(s+n),255*(o+n),255*n];case 2:return[255*n,255*(o+n),255*(s+n)];case 3:return[255*n,255*(s+n),255*(o+n)];case 4:return[255*(s+n),255*n,255*(o+n)];default:return[255*(o+n),255*n,255*(s+n)]}},minimum:function(t){for(var e=1e7,r=0;r<t.length;r++)t[r]<e&&(e=t[r]);return e},maximum:function(t){for(var e=-1e6,r=0;r<t.length;r++)t[r]>e&&(e=t[r]);return e},clamp:function(t,e,r){return e>t?e:t>r?r:t},colorDistance:function(t,e){this.colourDistance(t,e)},colourDistance:function(t,e){return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2)}},CLARITY.Pixel=function(t,e,r){this.r=0,this.g=0,this.b=0,this.h=0,this.s=0,this.v=0,this.setFromRGB(t,e,r)},CLARITY.Pixel.prototype={getColourValue:function(t){var t=this.channel||t||"grey";switch(t){case"grey":return.2989*this.r+.587*this.g+.114*this.b;case"red":case"r":return this.r;case"green":case"g":return this.g;case"blue":case"b":return this.b;case"hue":case"h":return this.h;case"saturation":case"s":return this.s;case"value":case"v":return this.v;default:return.2989*this.r+.587*this.g+.114*this.b}},setFromRGB:function(t,e,r){var a,i,o;return this.r=t,this.g=e,this.b=r,a=minimum([this.r,this.g,this.b]),i=maximum([this.r,this.g,this.b]),this.v=i,o=i-a,0==i?(this.s=0,void(this.h=-1)):(this.s=o/i,this.h=this.r==i?(this.g-this.b)/o:this.g==i?2+(this.b-this.r)/o:4+(this.r-this.g)/o,this.h*=60,void(this.h<0&&(this.h+=360)))},setFromHSV:function(t,e,r){var a,i,o,s,n;if(this.h=t,this.s=e,this.v=r,0==this.s)return void(this.r=this.g=this.b=this.v);switch(a=Math.floor(this.h/60),i=this.h-a,o=this.v*(1-this.s),s=this.v*(1-this.s*i),n=this.v*(1-this.s*(1-i)),a){case 0:this.r=r,this.g=n,this.b=o;break;case 1:this.r=s,this.g=r,this.b=o;break;case 2:this.r=o,this.g=r,this.b=n;break;case 3:this.r=o,this.g=s,this.b=r;break;case 4:this.r=n,this.g=o,this.b=r;break;default:this.r=r,this.g=o,this.b=s}}},CLARITY.AddSub=function(t){var t=t||{};this.properties={subtractive:t.subtractive||!1},CLARITY.Filter.call(this,t)},CLARITY.AddSub.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.AddSub.prototype.doProcess=function(t,e){for(var r=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.width*t.height*4;a+=4)this.properties.subtractive?(r.data[a]=t.data[a]-e.data[a],r.data[a+1]=t.data[a+1]-e.data[a+1],r.data[a+2]=t.data[a+2]-e.data[a+2]):(r.data[a]=t.data[a]+e.data[a],r.data[a+1]=t.data[a+1]+e.data[a+1],r.data[a+2]=t.data[a+2]+e.data[a+2]),r.data[a+3]=255;return r},CLARITY.AddSub.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createToggle("subtractive",this.properties.subtractive);return e.appendChild(r),r.addEventListener("change",function(){t.toggleBool("subtractive")}),e},CLARITY.Blend=function(t){var t=t||{};this.properties={ratio:CLARITY.Operations.clamp(t.ratio,0,1)||.5},CLARITY.Filter.call(this,t)},CLARITY.Blend.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Blend.prototype.doProcess=function(t,e){for(var r=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.width*t.height*4;a+=4)r.data[a+0]=t.data[a]*this.properties.ratio+e.data[a]*(1-this.properties.ratio),r.data[a+1]=t.data[a+1]*this.properties.ratio+e.data[a+1]*(1-this.properties.ratio),r.data[a+2]=t.data[a+2]*this.properties.ratio+e.data[a+2]*(1-this.properties.ratio),r.data[a+3]=255;return r},CLARITY.Blend.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,1,.01,"ratio",this.properties.ratio);return e.appendChild(r),r.getElementsByTagName("input")[0].addEventListener("change",function(e){t.setFloat("ratio",e.srcElement.value)}),e},CLARITY.Mask=function(t){var t=t||{};CLARITY.Filter.call(this,t)},CLARITY.Mask.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Mask.prototype.doProcess=function(t,e){for(var r=CLARITY.ctx.createImageData(t.width,t.height),a=0;a<t.width*t.height*4;a+=4)e[a].data<128?(r.data[a+0]=t.data[a],r.data[a+1]=t.data[a+1],r.data[a+2]=t.data[a+2]):(r.data[a+0]=0,r.data[a+1]=0,r.data[a+2]=0),r.data[a+3]=255;return r},CLARITY.Multiply=function(t){var t=t||{};CLARITY.Filter.call(this,t)},CLARITY.Multiply.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Multiply.prototype.doProcess=function(t,e){for(var r=CLARITY.ctx.createImageData(t.width,e.height),a=0;a<t.width*t.height*4;a+=4)r.data[a+0]=t.data[a]/255*e.data[a]/255*255,r.data[a+1]=t.data[a+1]/255*e.data[a+1]/255*255,r.data[a+2]=t.data[a+2]/255*e.data[a+2]/255*255,r.data[a+3]=255;return r},CLARITY.Contourer=function(t){var t=t||{};this.properties={contours:t.contours||10},this.threshes=[128,256],this.threshSets=[0,256],this.difference=128,this.maxValue=0,this.minValue=255,CLARITY.Filter.call(this,t)},CLARITY.Contourer.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Contourer.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.data.length;r+=4)t.data[r]>this.maxValue?this.maxValue=t.data[r]:t.data[r]<this.minValue&&(this.minValue=t.data[r]);this.setVar(this.properties.contours);for(var r=0;r<t.data.length;r++)if((r+1)%4!=0){for(var a=0;a<this.threshes.length;a++)if(t.data[r]<this.threshes[a]){e.data[r]=this.threshSets[a];break}}else e.data[r]=255;return e},CLARITY.Contourer.prototype.setVar=function(t){this.threshes=[],this.difference=(this.maxValue-this.minValue)/t;for(var e=0,r=this.difference+this.minValue;256>=r;r+=this.difference)this.threshes[e]=r,this.threshSets[e]=(r-this.difference-this.minValue)/(this.maxValue-this.minValue)*255,e++;this.threshes[e]=r,this.threshSets[e]=255},CLARITY.Contourer.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(1,20,1,"contours",this.properties.contours);return e.appendChild(r),r.addEventListener("change",function(e){t.setInt("contours",e.srcElement.value)}),e},CLARITY.NormalFlip=function(t){var t=t||{};this.properties={red:t.red||!1,green:t.green||!1,swap:t.swap||!1},CLARITY.Filter.call(this,t)},CLARITY.NormalFlip.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.NormalFlip.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.width*t.height*4;r+=4){if(e.data[r]=this.properties.red?255-t.data[r]:t.data[r],e.data[r+1]=this.properties.green?255-t.data[r+1]:t.data[r+1],this.properties.swap){var a=e.data[r];e.data[r]=e.data[r+1],e.data[r+1]=a}e.data[r+2]=t.data[r+2],e.data[r+3]=255}return e},CLARITY.NormalFlip.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createToggle("Red",this.properties.red);return e.appendChild(r),r.addEventListener("change",function(){t.toggleBool("red")}),r=CLARITY.Interface.createToggle("Green",this.properties.green),e.appendChild(r),r.addEventListener("change",function(){t.toggleBool("green")}),r=CLARITY.Interface.createToggle("Swap",this.properties.swap),e.appendChild(r),r.addEventListener("change",function(){t.toggleBool("swap")}),e},CLARITY.NormalGenerator=function(t){var t=t||{};this.properties={intensity:t.intensity||.5},CLARITY.Filter.call(this,t)},CLARITY.NormalGenerator.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.NormalGenerator.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=1;r<t.height-1;r++)for(var a=1;a<t.width-1;a++){var i=4*(r*t.width+a),o=4*((r-1)*t.width+a),s=4*((r+1)*t.width+a),n=4*(r*t.width+(a-1)),h=4*(r*t.width+(a+1)),d={x:a,y:r,z:this.properties.intensity*this.getColourValue(t,i,"grey")},l={x:a-1,y:r,z:this.properties.intensity*this.getColourValue(t,n,"grey")},c={x:a+1,y:r,z:this.properties.intensity*this.getColourValue(t,h,"grey")},p={x:a,y:r-1,z:this.properties.intensity*this.getColourValue(t,o,"grey")},u={x:a,y:r+1,z:this.properties.intensity*this.getColourValue(t,s,"grey")},f=this.generateNormal(d,l,c,p,u);e.data[i]=255*(1-(f.x/2+.5)),e.data[i+1]=255*(1-(f.y/2+.5)),e.data[i+2]=255*-f.z,e.data[i+3]=255}for(var r=0;r<t.height;r++){var a=0,i=4*(r*t.width+a),C=4*(r*t.width+a+1);e.data[i]=e.data[C],e.data[i+1]=e.data[C+1],e.data[i+2]=e.data[C+2],e.data[i+3]=255,a=t.width-1,i=4*(r*t.width+a),C=4*(r*t.width+a-1),e.data[i]=e.data[C],e.data[i+1]=e.data[C+1],e.data[i+2]=e.data[C+2],e.data[i+3]=255}for(var a=0;a<t.width;a++){var r=0,i=4*(r*t.width+a),C=4*((r+1)*t.width+a+1);e.data[i]=e.data[C],e.data[i+1]=e.data[C+1],e.data[i+2]=e.data[C+2],e.data[i+3]=255,r=t.height-1,i=4*(r*t.width+a),C=4*((r-1)*t.width+a),e.data[i]=e.data[C],e.data[i+1]=e.data[C+1],e.data[i+2]=e.data[C+2],e.data[i+3]=255}return e},CLARITY.NormalGenerator.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,3,.1,"intensity",this.properties.intensity);return e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("intensity",e.srcElement.value)}),e},CLARITY.NormalGenerator.prototype.generateNormal=function(t,e,r,a,i){var o=[];e&&a&&o.push(this.calcNormal(t,a,e)),e&&i&&o.push(this.calcNormal(t,e,i)),r&&i&&o.push(this.calcNormal(t,i,r)),r&&a&&o.push(this.calcNormal(t,r,a));var s=this.average(o);return s},CLARITY.NormalGenerator.prototype.calcNormal=function(t,e,r){var a=this.vectorSub(t,e),i=this.vectorSub(t,r),o=this.crossProduct(a,i);return o=this.normalise(o)},CLARITY.NormalGenerator.prototype.vectorSub=function(t,e){return{x:t.x-e.x,y:t.y-e.y,z:t.z-e.z}},CLARITY.NormalGenerator.prototype.vectorAdd=function(t,e){return{x:t.x+e.x,y:t.y+e.y,z:t.z+e.z}},CLARITY.NormalGenerator.prototype.crossProduct=function(t,e){return{x:t.y*e.z-t.z*e.y,y:-(t.x*e.z-t.z*e.x),z:t.x*e.y-t.y*e.x}},CLARITY.NormalGenerator.prototype.normalise=function(t){var e=Math.sqrt(Math.abs(t.x*t.x+t.y*t.y+t.z*t.z));return{x:t.x/e,y:t.y/e,z:t.z/e}},CLARITY.NormalGenerator.prototype.average=function(t){for(var e=t[0],r=1;r<t.length;r++)e=this.vectorAdd(e,t[r]);return e=this.normalise(e),{x:e.x,y:e.y,z:e.z}},CLARITY.NormalIntensity=function(t){var t=t||{};this.properties={intensity:t.intensity||.5},CLARITY.Filter.call(this,t)},CLARITY.NormalIntensity.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.NormalIntensity.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.height;r++)for(var a=0;a<t.width;a++){var i=4*(r*t.width+a),o={x:(t.data[i]-128)/128,y:(t.data[i+1]-128)/128,z:t.data[i+2]/255};o=this.normalise(o),o.x*=this.properties.intensity,o.y*=this.properties.intensity,o=this.normalise(o),e.data[i]=128*(o.x+1),e.data[i+1]=128*(o.y+1),e.data[i+2]=255*o.z,e.data[i+3]=255}return e},CLARITY.NormalIntensity.prototype.normalise=function(t){var e=Math.sqrt(Math.abs(t.x*t.x+t.y*t.y+t.z*t.z));return{x:t.x/e,y:t.y/e,z:t.z/e}},CLARITY.NormalIntensity.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,2,.1,"intensity",this.properties.intensity);return e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("intensity",e.srcElement.value)}),e},CLARITY.Brickulate=function(t){var t=t||{};this.properties={horizontalSegs:t.horizontalSegs||4,verticalSegs:t.verticalSegs||4,grooveSize:t.grooveSize||5,offset:t.offset||!1},CLARITY.Filter.call(this,t)},CLARITY.Brickulate.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Brickulate.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=Math.round(t.width/this.properties.horizontalSegs),a=Math.round(t.height/this.properties.verticalSegs),i=this.properties.grooveSize,o=0;o<4*t.height;o++)for(var s=0;s<4*t.width;s++){var n=4*(o*t.width+s),h=s%r,d=o%a;this.properties.offset&&a>o%(2*a)&&(h+=.5*r,h>r&&(h-=r)),(i>=h||h>=r-5)&&(i>=d||d>=a-5)?(e.data[n]=Math.max(255*(i-h)/i,255*(h-r+i)/i,255*(i-d)/i,255*(d-a+i)/i),e.data[n+1]=Math.max(255*(i-h)/i,255*(h-r+i)/i,255*(i-d)/i,255*(d-a+i)/i),e.data[n+2]=Math.max(255*(i-h)/i,255*(h-r+i)/i,255*(i-d)/i,255*(d-a+i)/i)):i>=h?(e.data[n]=255*(i-h)/i,e.data[n+1]=255*(i-h)/i,e.data[n+2]=255*(i-h)/i):h>=r-5?(e.data[n]=255*(h-r+i)/i,e.data[n+1]=255*(h-r+i)/i,e.data[n+2]=255*(h-r+i)/i):i>=d?(e.data[n]=255*(i-d)/i,e.data[n+1]=255*(i-d)/i,e.data[n+2]=255*(i-d)/i):d>=a-5?(e.data[n]=255*(d-a+i)/i,e.data[n+1]=255*(d-a+i)/i,e.data[n+2]=255*(d-a+i)/i):(e.data[n]=0,e.data[n+1]=0,e.data[n+2]=0),e.data[n+3]=255}return e},CLARITY.Brickulate.prototype.doCreateControls=function(){var t=CLARITY.Interface.createDiv();return t},CLARITY.DifferenceDetector=function(t){var t=t||{};this.original=null,CLARITY.Filter.call(this,t)},CLARITY.DifferenceDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DifferenceDetector.prototype.doProcess=function(t){if(!this.original)return this.original=t,t;for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.width*t.height*4;r+=4){var a=[this.original.data[r],this.original.data[r+1],this.original.data[r+2]],i=[t.data[r],t.data[r+1],t.data[r+2]];findDifference(i,a)?(e.data[r]=t.data[r],e.data[r+1]=t.data[r+1],e.data[r+2]=t.data[r+2],e.data[r+3]=255):(e.data[r]=0,e.data[r+1]=0,e.data[r+2]=0,e.data[r+3]=255)}return e},CLARITY.DifferenceDetector.prototype.resetOriginal=function(){this.original=null},CLARITY.DifferenceDetector.prototype.findDifference=function(t,e){return t[0]<e[0]+75&&t[0]>e[0]-75&&t[1]<e[1]+75&&t[1]>e[1]-75&&t[2]<e[2]+75&&t[2]>e[2]-75?!1:!0},CLARITY.Ghoster=function(t){var t=t||{};this.length=t.length||10,this.frames=new Array,CLARITY.Filter.call(this,t)},CLARITY.Ghoster.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Ghoster.prototype.doProcess=function(t){this.frames.unshift(t),this.frames.length>this.length&&this.frames.pop();for(var e=CLARITY.ctx.createImageData(width,height),r=0;r<t.data.length;r+=4){for(var a=0;a<this.frames.length;a++)e.data[r]+=this.frames[a].data[r]/this.frames.length*(a/this.frames.length)*2,e.data[r+1]+=this.frames[a].data[r+1]/this.frames.length*(a/this.frames.length)*2,e.data[r+2]+=this.frames[a].data[r+2]/this.frames.length*(a/this.frames.length)*2;e.data[r+3]=255}return e},CLARITY.Puzzler=function(t){var t=t||{};this.selected=null,this.properties={horizontalSegs:t.horizontalSegs||4,verticalSegs:t.verticalSegs||4},this.swaps=[];for(var e=0,r=0;r<this.properties.verticalSegs;r++){this.swaps[r]=[];for(var a=0;a<this.properties.horizontalSegs;a++)this.swaps[r][a]=e++}for(var r=0;r<10*(this.properties.verticalSegs+this.properties.horizontalSegs)/2;r++){var i=Math.floor(Math.random()*this.properties.verticalSegs),o=Math.floor(Math.random()*this.properties.horizontalSegs),s=Math.floor(Math.random()*this.properties.verticalSegs),n=Math.floor(Math.random()*this.properties.horizontalSegs),h=this.swaps[i][o];this.swaps[i][o]=this.swaps[s][n],this.swaps[s][n]=h}CLARITY.Filter.call(this,t)},CLARITY.Puzzler.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Puzzler.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=Math.round(t.height/this.properties.verticalSegs),a=Math.round(t.width/this.properties.horizontalSegs),i=0;i<this.properties.verticalSegs;i++)for(var o=0;o<this.properties.horizontalSegs;o++)for(var s=this.numToPos(this.swaps[i][o]),n=0;r>n;n++)for(var h=0;a>h;h++){var d=4*((i*r+n)*t.width+(o*a+h)),l=4*((s[1]*r+n)*t.width+(s[0]*a+h)),c=this.getPixel(t.data,l);e.data[d]=c[0],e.data[d+1]=c[1],e.data[d+2]=c[2],e.data[d+3]=255}if(void 0!=this.selected)for(var i=0;i<this.height/this.properties.verticalSegs;i++)for(var o=0;o<this.width/this.properties.horizontalSegs;o++){var d=4*((this.selected[1]*(this.height/this.properties.verticalSegs)+i)*this.width+(this.selected[0]*(this.width/this.properties.horizontalSegs)+o));e.data[d+2]+=80}return e},CLARITY.Puzzler.prototype.getPixel=function(t,e){return[t[e],t[e+1],t[e+2]]},CLARITY.Puzzler.prototype.setPixel=function(t,e,r,a){var i=4*(r*this.width+e);t.data[i]=a[0],t.data[i+1]=a[1],t.data[i+2]=a[2]},CLARITY.Puzzler.prototype.setClick=function(t){var e=Math.floor(t[0]/(this.width/this.properties.horizontalSegs)),r=Math.floor(t[1]/(this.height/this.properties.verticalSegs));if(this.selected){var a=this.swaps[this.selected[0]][this.selected[1]];this.swaps[this.selected[0]][this.selected[1]]=this.swaps[e][r],this.swaps[e][r]=a,this.selected=void 0}else this.selected=[e,r]},CLARITY.Puzzler.prototype.numToPos=function(t){for(var e=0,r=0;t>this.properties.horizontalSegs-1;)t-=this.properties.horizontalSegs,e++;return r=t,[e,r]},CLARITY.Desaturate=function(t){var t=t||{};CLARITY.Filter.call(this,t)},CLARITY.Desaturate.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Desaturate.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.width*t.height*4;r+=4){var a=this.getColourValue(t,r,"grey");e.data[r+0]=a,e.data[r+1]=a,e.data[r+2]=a,e.data[r+3]=255}return e},CLARITY.DotRemover=function(t){var t=t||{};this.neighboursReq=t.neighboursReq||1,CLARITY.Filter.call(this,t)},CLARITY.DotRemover.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DotRemover.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=1;r<t.height-1;r++)for(var a=1;a<t.width-1;a++){var i=4*(r*t.width+a),o=4*((r-1)*t.width+a),s=4*((r+1)*t.width+a),n=4*(r*t.width+(a-1)),h=4*(r*t.width+(a+1)),d=t.data[i],l=0;t.data[o]==d&&l++,t.data[s]==d&&l++,t.data[n]==d&&l++,t.data[h]==d&&l++,l<=this.neighboursReq?d>138?(e.data[i]=0,e.data[i+1]=0,e.data[i+2]=0):(e.data[i]=255,e.data[i+1]=255,e.data[i+2]=255):(e.data[i]=d,e.data[i+1]=d,e.data[i+2]=d),e.data[i+3]=255}return e},CLARITY.hsvShifter=function(t){var t=t||{};this.properties={hue:t.hue||0,saturation:t.saturation||1,value:t.value||t.lightness||1},CLARITY.Filter.call(this,t)},CLARITY.hsvShifter.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.hsvShifter.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.width*t.height*4;r+=4){var a=CLARITY.Operations.RGBtoHSV([t.data[r],t.data[r+1],t.data[r+2]]);a[0]+=this.properties.hue,a[0]>360&&(a[0]-=360),a[1]*=this.properties.saturation,a[2]*=this.properties.value,a=CLARITY.Operations.HSVtoRGB([a[0],a[1],a[2]]),e.data[r+0]=a[0],e.data[r+1]=a[1],e.data[r+2]=a[2],e.data[r+3]=255}return e},CLARITY.hsvShifter.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,360,1,"hue",this.properties.hue);return e.appendChild(r),r.getElementsByTagName("input")[0].addEventListener("change",function(e){t.setFloat("hue",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,2,.1,"saturation",this.properties.saturation),e.appendChild(r),r.getElementsByTagName("input")[0].addEventListener("change",function(e){t.setFloat("saturation",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,2,.1,"lightness",this.properties.lightness),e.appendChild(r),r.getElementsByTagName("input")[0].addEventListener("change",function(e){t.setFloat("value",e.srcElement.value)}),e},CLARITY.Invert=function(t){var t=t||{};this.properties={dynamic:t.dynamic||!1},CLARITY.Filter.call(this,t)},CLARITY.Invert.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Invert.prototype.doProcess=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);if(this.properties.dynamic){for(var r=255,a=0,i=0;i<t.width*t.height*4;i+=4){var o=this.getColourValue(t,i,this.channel);r>o&&(r=o),o>a&&(a=o)}for(var i=0;i<t.width*t.height*4;i+=4)e.data[i]=a-r-t.data[i]+r,e.data[i+1]=a-r-t.data[i+1]+r,e.data[i+2]=a-r-t.data[i+2]+r,e.data[i+3]=255}else for(var i=0;i<t.width*t.height*4;i+=4)e.data[i]=255-t.data[i],e.data[i+1]=255-t.data[i+1],e.data[i+2]=255-t.data[i+2],e.data[i+3]=255;return e},CLARITY.Noise=function(t){var t=t||{};this.properties={intensity:t.intensity||1,monochromatic:t.monochromatic||!1},CLARITY.Filter.call(this,t)},CLARITY.Noise.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Noise.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.width*t.height*4;r+=4){if(this.properties.monochromatic){var a=2*(Math.random()-.5)*this.properties.intensity;e.data[r]=t.data[r]+a,e.data[r+1]=t.data[r+1]+a,e.data[r+2]=t.data[r+2]+a}else e.data[r]=t.data[r]+2*(Math.random()-.5)*this.properties.intensity,e.data[r+1]=t.data[r+1]+2*(Math.random()-.5)*this.properties.intensity,e.data[r+2]=t.data[r+2]+2*(Math.random()-.5)*this.properties.intensity;e.data[r+3]=255}return e},CLARITY.Noise.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,10,.1,"intensity",this.properties.intensity);e.appendChild(r),r.getElementsByTagName("input")[0].addEventListener("change",function(e){t.setFloat("intensity",e.srcElement.value)});var a=CLARITY.Interface.createToggle("monochromatic",this.properties.monochromatic);return e.appendChild(a),a.getElementsByTagName("input")[0].addEventListener("change",function(){t.toggleBool("monochromatic")}),e},CLARITY.Pixelate=function(t){var t=t||{};this.properties={size:t.size||64},CLARITY.Filter.call(this,t)},CLARITY.Pixelate.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Pixelate.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=this.properties.size;t.height%r!=0;)r--;for(var a=Math.round(r/2),i=0;i<t.height;i+=r)for(var o=0;o<t.width;o+=r)for(var s=4*((i+a)*t.width+(o+a)),n=0;r>n;n++)for(var h=0;r>h;h++){var d=4*((n+i)*t.width+h+o);e.data[d]=t.data[s],e.data[d+1]=t.data[s+1],e.data[d+2]=t.data[s+2],e.data[d+3]=255}return e},CLARITY.Pixelate.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,256,1,"size",this.properties.size);return e.appendChild(r),r.addEventListener("change",function(e){t.setInt("size",e.srcElement.value)}),e},CLARITY.Posteriser=function(t){var t=t||{};this.properties={},this.method=t.method,"fast"==this.method?(this.threshes=[128,256],this.difference=32,this.setThresh(64)):(this.properties.colours=t.colours||5,this.MCut=(new CLARITY.MCut).MCut),CLARITY.Filter.call(this,t)},CLARITY.Posteriser.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Posteriser.prototype.doProcess=function(t){if("fast"==this.method)return this.oldMethod(t);for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=[],a=0;a<t.data.length;a+=4)r.push([t.data[a],t.data[a+1],t.data[a+2]]);this.MCut.init(r);for(var i,o,s=this.MCut.get_fixed_size_palette(this.properties.colours),a=0;a<t.data.length;a+=4){var n,h=[t.data[a],t.data[a+1],t.data[a+2]];if(o&&i+5>n&&n>i-5)n=CLARITY.Operations.colourDistance(h,o),d=o;else{for(var d=s[0],l=CLARITY.Operations.colourDistance(h,d),c=1;c<s.length;c++)n=CLARITY.Operations.colourDistance(h,s[c]),l>n&&(l=n,d=s[c]);o=d,i=l}e.data[a]=d[0],e.data[a+1]=d[1],e.data[a+2]=d[2],e.data[a+3]=255}return e},CLARITY.Posteriser.prototype.oldMethod=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);this.setThresh(Math.round(255/this.properties.colours));for(var r=0;r<t.data.length;r+=4)if((r+1)%4!=0){for(var a=0;a<this.threshes.length;a++)if(t.data[r]<this.threshes[a]){e.data[r]=this.threshes[a]-this.difference/2;break}}else e.data[r]=255;return e},CLARITY.Posteriser.prototype.setThresh=function(t){this.threshes=[],this.difference=t;for(var e=0,r=this.difference;256>=r;r+=this.difference)this.threshes[e]=r,e++;this.threshes[e]=r},CLARITY.Posteriser.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(1,20,1,"Colours",this.properties.colours);return e.appendChild(r),r.addEventListener("change",function(e){t.setInt("colours",e.srcElement.value)}),e},CLARITY.Sharpen=function(t){var t=t||{};this.properties={intensity:t.intensity||1},this.makeKernel(this.properties.intensity),CLARITY.Filter.call(this,t)},CLARITY.Sharpen.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Sharpen.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=4;r<4*t.height-4;r+=4)for(var a=4;a<4*t.width-4;a+=4){for(var i=0,o=0,s=0,n=-1;1>=n;n++)for(var h=-1;1>=h;h++){var d=(r+4*n)*t.width+(a+4*h),l=this.getColourValue(t,d,"red"),c=this.getColourValue(t,d,"green"),p=this.getColourValue(t,d,"blue");i+=this.kernel[n+1][h+1]*l,o+=this.kernel[n+1][h+1]*c,s+=this.kernel[n+1][h+1]*p}e.data[r*t.width+a]=i,e.data[r*t.width+a+1]=o,e.data[r*t.width+a+2]=s,e.data[r*t.width+a+3]=255}return e},CLARITY.Sharpen.prototype.makeKernel=function(t){this.kernel=[[-t,-t,-t],[-t,8*t+1,-t],[-t,-t,-t]]},CLARITY.Sharpen.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,3,.1,"Intensity",this.properties.intensity);return e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("intensity",e.srcElement.value),t.makeKernel(t.properties.intensity)}),e},CLARITY.Smoother=function(t){var t=t||{};this.iterations=t.iterations||1,this.properties={iterations:t.iterations||1},CLARITY.Filter.call(this,t)},CLARITY.Smoother.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Smoother.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<this.properties.iterations;r++)for(var a=0;a<t.height;a++)for(var i=0;i<t.width;i++){var o=4*(a*t.width+i),s=4*((a-1)*t.width+i),n=4*((a+1)*t.width+i),h=4*(a*t.width+(i-1)),d=4*(a*t.width+(i+1)),l=0,c=[0,0,0];0!=i&&(c[0]+=t.data[h],c[1]+=t.data[h+1],c[2]+=t.data[h+2],l++),i!=t.width-1&&(c[0]+=t.data[d],c[1]+=t.data[d+1],c[2]+=t.data[d+2],l++),0!=a&&(c[0]+=t.data[s],c[1]+=t.data[s+1],c[2]+=t.data[s+2],l++),a!=t.height-1&&(c[0]+=t.data[n],c[1]+=t.data[n+1],c[2]+=t.data[n+2],l++),e.data[o]=c[0]/l,e.data[o+1]=c[1]/l,e.data[o+2]=c[2]/l,e.data[o+3]=255}return e},CLARITY.Smoother.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(1,5,1,"iterations",this.properties.iterations);return e.appendChild(r),r.addEventListener("change",function(e){t.setInt("iterations",e.srcElement.value)}),e},CLARITY.EdgeDetector=function(t){var t=t||{};this.properties={fast:t.fast||!1},this.kernel=[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],CLARITY.Filter.call(this,t)},CLARITY.EdgeDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.EdgeDetector.prototype.doProcess=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);
if(this.properties.fast)for(var r=4;r<4*t.height-4;r+=4)for(var a=4;a<4*t.width-4;a+=4){var i=r*t.width+a;e.data[i]=5*Math.abs(this.getColourValue(t,i+4)-this.getColourValue(t,i)),e.data[i+1]=5*Math.abs(this.getColourValue(t,i+4)-this.getColourValue(t,i)),e.data[i+2]=5*Math.abs(this.getColourValue(t,i+4)-this.getColourValue(t,i)),e.data[i+3]=255}else for(var r=4;r<4*t.height-4;r+=4)for(var a=4;a<4*t.width-4;a+=4){for(var o=0,s=-1;1>=s;s++)for(var n=-1;1>=n;n++){var h=(r+4*s)*t.width+(a+4*n),d=this.getColourValue(t,h);o+=this.kernel[s+1][n+1]*d}e.data[r*t.width+a]=o,e.data[r*t.width+a+1]=o,e.data[r*t.width+a+2]=o,e.data[r*t.width+a+3]=255}return e},CLARITY.EdgeDetector.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createToggle("fast",this.properties.fast);return e.appendChild(r),r.addEventListener("change",function(){t.toggleBool("fast")}),e},CLARITY.MotionDetector=function(t){this.frames=[],this.index=0;var t=t||{};this.properties={frameCount:t.frameCount||1},this.preindex=this.properties.frameCount,CLARITY.Filter.call(this,t)},CLARITY.MotionDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MotionDetector.prototype.doProcess=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);if(this.pushFrame(t),this.frames.length<this.properties.frameCount+1)return e;for(var r=0;r<t.width*t.height*4;r+=4)e.data[r+0]=Math.abs(this.getColourValue(this.frames[this.preindex],r)-this.getColourValue(this.frames[this.index],r)),e.data[r+1]=Math.abs(this.getColourValue(this.frames[this.preindex],r)-this.getColourValue(this.frames[this.index],r)),e.data[r+2]=Math.abs(this.getColourValue(this.frames[this.preindex],r)-this.getColourValue(this.frames[this.index],r)),e.data[r+3]=255;return e},CLARITY.MotionDetector.prototype.pushFrame=function(t){this.frames[this.index]=CLARITY.ctx.createImageData(t.width,t.height);for(var e=0;e<t.data.length;e++)this.frames[this.index].data[e]=t.data[e];this.index++,this.index>this.properties.frameCount&&(this.index=0),this.preindex++,this.preindex>this.properties.frameCount&&(this.preindex=0)},CLARITY.MotionDetector.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(1,24,1,"Frame Count",this.properties.frameCount);return e.appendChild(r),r.addEventListener("change",function(e){t.setInt("frameCount",e.srcElement.value),t.index=0,t.preindex=e.srcElement.value-1,t.frames=[]}),e},CLARITY.SkinDetector=function(t){var t=t||{};CLARITY.Filter.call(this,t)},CLARITY.SkinDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.SkinDetector.prototype.doProcess=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);this.RGBAtoYCbCr(e,t);for(var r=0;r<t.width*t.height*4;r+=4)e.data[r]>30&&80<e.data[r+1]&&e.data[r+1]<121&&133<e.data[r+2]&&e.data[r+2]<173?(e.data[r+0]=255,e.data[r+1]=255,e.data[r+2]=255):(e.data[r+0]=0,e.data[r+1]=0,e.data[r+2]=0),e.data[r+3]=255;return e},CLARITY.SkinDetector.prototype.RGBAtoYCbCr=function(t,e){for(var r,a,i,o=0;o<e.width*e.height*4;o+=4)r=16+(66*e.data[o]+129*e.data[o+1]+25*e.data[o+2])/256,a=128+(-38*e.data[o]-74*e.data[o+1]+112*e.data[o+2])/256,i=128+(112*e.data[o]-94*e.data[o+1]-18*e.data[o+2])/256,t.data[o]=r,t.data[o+1]=a,t.data[o+2]=i},CLARITY.Cloud=function(t){var t=t||{};this.properties={red:t.red||0,green:t.green||0,blue:t.blue||0,linear:t.linear||!1,iterations:t.iterations||4,initialSize:t.initialSize||4},CLARITY.Filter.call(this,t)},CLARITY.Cloud.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Cloud.prototype.doProcess=function(t){for(var e=this.properties.initialSize,r=0,a=[],i=0;i<t.height*t.width*3;i++)a[i]=0;for(var o=0;o<this.properties.iterations&&(e*=o+1,!(e>t.width));o++){r++;for(var s=[],i=0;e>i;i++){s[i]=[];for(var n=0;e>n;n++)s[i][n]=Math.round(255*Math.random())}for(var h=0;h<t.height;h++)for(var d=0;d<t.width;d++){var i=3*(h*t.width+d),l=d%(t.width/e)/(t.width/e),c=h%(t.height/e)/(t.height/e),p=Math.floor(d/t.width*e),u=Math.ceil(d/t.width*e);u>=e&&(u=0);var f=Math.floor(h/t.height*e),C=Math.ceil(h/t.height*e);C>=e&&(C=0);var I,g,v;this.properties.linear||(l=this.smoothStep(l),c=this.smoothStep(c)),I=this.linearInterpolate(s[f][p],s[f][u],l),g=this.linearInterpolate(s[C][p],s[C][u],l),v=this.linearInterpolate(I,g,c),a[i]+=v/(o+1),a[i+1]+=v/(o+1),a[i+2]+=v/(o+1)}}for(var L=CLARITY.ctx.createImageData(t.width,t.height),T=0;T<a.length;T++){var i=3*T,n=4*T;L.data[n]=a[i]/r*this.properties.red/255,L.data[n+1]=a[i+1]/r*this.properties.green/255,L.data[n+2]=a[i+2]/r*this.properties.blue/255,L.data[n+3]=255}return L},CLARITY.Cloud.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,255,1,"red",this.properties.red);e.appendChild(r),r.addEventListener("change",function(e){t.setInt("red",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,255,1,"green",this.properties.green),e.appendChild(r),r.addEventListener("change",function(e){t.setInt("green",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,255,1,"blue",this.properties.blue),e.appendChild(r),r.addEventListener("change",function(e){t.setInt("blue",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,10,1,"iterations",this.properties.iterations),e.appendChild(r),r.addEventListener("change",function(e){t.setInt("iterations",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,16,1,"Initial Size",this.properties.initialSize),e.appendChild(r),r.addEventListener("change",function(e){t.setInt("initialSize",e.srcElement.value)});var a=CLARITY.Interface.createToggle("linear",this.properties.linear);return e.appendChild(a),a.addEventListener("change",function(){t.toggleBool("linear")}),e},CLARITY.Cloud.prototype.linearInterpolate=function(t,e,r){return t+(e-t)*r},CLARITY.Cloud.prototype.smoothStep=function(t){return t*t*(3-2*t)},CLARITY.Cloud.prototype.smootherStep=function(t){return t*t*t*(t*(6*t-15)+10)},CLARITY.FillHSV=function(t){var t=t||{};this.properties={hue:t.hue||0,saturation:t.saturation||0,value:t.value||t.lightness||0},CLARITY.Filter.call(this,t)},CLARITY.FillHSV.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.FillHSV.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=CLARITY.Operations.HSVtoRGB([this.properties.hue,this.properties.saturation,this.properties.value]),a=0;a<t.width*t.height*4;a+=4)e.data[a]=r[0],e.data[a+1]=r[1],e.data[a+2]=r[2],e.data[a+3]=255;return e},CLARITY.FillHSV.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,360,1,"hue",this.properties.hue);return e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("hue",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,2,.1,"saturation",this.properties.saturation),e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("saturation",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,2,.1,"lightness",this.properties.value),e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("value",e.srcElement.value)}),e},CLARITY.FillRGB=function(t){var t=t||{};this.properties={red:t.red||0,green:t.green||0,blue:t.blue||0},CLARITY.Filter.call(this,t)},CLARITY.FillRGB.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.FillRGB.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.width*t.height*4;r+=4)e.data[r]=this.properties.red,e.data[r+1]=this.properties.green,e.data[r+2]=this.properties.blue,e.data[r+3]=255;return e},CLARITY.FillRGB.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,255,1,"red",this.properties.red);return e.appendChild(r),r.addEventListener("change",function(e){t.setInt("red",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,255,1,"green",this.properties.green),e.appendChild(r),r.addEventListener("change",function(e){t.setInt("green",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,255,1,"blue",this.properties.blue),e.appendChild(r),r.addEventListener("change",function(e){t.setInt("blue",e.srcElement.value)}),e},CLARITY.GradientThreshold=function(t){var t=t||{};this.properties={threshold:t.threshold||20,distance:t.distance||1},CLARITY.Filter.call(this,t)},CLARITY.GradientThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.GradientThreshold.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=!1,a=this.properties.distance;a<t.height-this.properties.distance;a++)for(var i=this.properties.distance;i<t.width-this.properties.distance;i++){r=!1;var o=4*(a*t.width+i),s=4*((a-this.properties.distance)*t.width+i),n=4*((a+this.properties.distance)*t.width+i),h=4*(a*t.width+(i-this.properties.distance)),d=4*(a*t.width+(i+this.properties.distance));t.data[o]<t.data[h]-this.properties.threshold?r=!0:t.data[o]>t.data[h]+this.properties.threshold?r=!0:t.data[o]<t.data[d]-this.properties.threshold?r=!0:t.data[o]>t.data[d]+this.properties.threshold?r=!0:t.data[o]<t.data[s]-this.properties.threshold?r=!0:t.data[o]>t.data[s]+this.properties.threshold?r=!0:t.data[o]<t.data[n]-this.properties.threshold?r=!0:t.data[o]>t.data[n]+this.properties.threshold&&(r=!0),r?(e.data[o+0]=255,e.data[o+1]=255,e.data[o+2]=255,e.data[o+3]=255):(e.data[o+0]=0,e.data[o+1]=0,e.data[o+2]=0,e.data[o+3]=255)}return e},CLARITY.GradientThreshold.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,100,1,"Threshold",this.properties.threshold);return e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("threshold",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,10,1,"Distance",this.properties.distance),e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("distance",e.srcElement.value)}),e},CLARITY.MedianThreshold=function(t){CLARITY.Filter.call(this,t)},CLARITY.MedianThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MedianThreshold.prototype.doProcess=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);this.threshes=this.getThresholdValues(t),this.threshes.push(256);for(var r=0;r<t.data.length;r++)if((r+1)%4!=0){for(var a=0;a<this.threshes.length;a++)if(t.data[r]<this.threshes[a]){e.data[r]=this.threshes[a];break}}else e.data[r]=255;return e},CLARITY.MedianThreshold.prototype.getThresholdValues=function(t){for(var e=new Array,r=[0,0,0],a=0;256>a;a++)e[a]=0;for(var a=0;a<t.data.length;a+=4)e[t.data[a]]++;for(var i=0,o=t.data.length/4/4,s=0,a=0;256>a;a++)i+=e[a],i>o&&(o+=t.data.length/4/4,r[s]=a,s++);return r},CLARITY.ValueThreshold=function(t){var t=t||{};this.properties={inverted:t.inverted||!1,threshold:t.threshold||null},CLARITY.Filter.call(this,t)},CLARITY.ValueThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.ValueThreshold.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=this.properties.threshold||this.getThresholdValue(t),a=0;a<t.width*t.height*4;a+=4){var i=this.getColourValue(t,a,this.channel);this.properties.inverted?r>i?(e.data[a+0]=255,e.data[a+1]=255,e.data[a+2]=255):(e.data[a+0]=0,e.data[a+1]=0,e.data[a+2]=0):i>r?(e.data[a+0]=255,e.data[a+1]=255,e.data[a+2]=255):(e.data[a+0]=0,e.data[a+1]=0,e.data[a+2]=0),e.data[a+3]=255}return e},CLARITY.ValueThreshold.prototype.getThresholdValue=function(t){var e;e=this.getColourValue(t,0);for(var r=4;r<t.width*t.height*4;r+=4){var a=this.getColourValue(t,r);e=(e+a)/2}for(var i=0,o=0,s=0,n=e;!(s>n-1&&n+1>s);){s=n;for(var r=0;r<t.width*t.height*4;r+=4){var a=this.getColourValue(t,r);s>a?i=0==i?a:(i+a)/2:o=0==o?a:(o+a)/2}n=(o+i)/2,i=0,o=0}return n},CLARITY.ValueThreshold.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createToggle("Inverted",this.properties.inverted);e.appendChild(r),r.addEventListener("change",function(){t.toggleBool("inverted")});var a=CLARITY.Interface.createSlider(0,255,1,"Threshold",this.properties.threshold);return e.appendChild(a),a.addEventListener("change",function(e){t.setFloat("threshold",e.srcElement.value)}),e},CLARITY.Mirror=function(t){var t=t||{};this.properties={Horizontal:t.Horizontal||!0,Vertical:t.Vertical||!1},CLARITY.Filter.call(this,t)},CLARITY.Mirror.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Mirror.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.height;r++)for(var a=0;a<t.width;a++){var i=4*(r*t.width+a),o=a,s=r;this.properties.Horizontal&&(o=t.width-a),this.properties.Vertical&&(s=t.height-r);var n=4*(s*t.width+o);e.data[n]=t.data[i],e.data[n+1]=t.data[i+1],e.data[n+2]=t.data[i+2],e.data[n+3]=255}return e},CLARITY.Mirror.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createToggle("Vertical",this.properties.Vertical);return e.appendChild(r),r.addEventListener("change",function(){t.toggleBool("Vertical")}),r=CLARITY.Interface.createToggle("Horizontal",this.properties.Horizontal),e.appendChild(r),r.addEventListener("change",function(){t.toggleBool("Horizontal")}),e},CLARITY.Rotator=function(t){var t=t||{};for(this.properties={turns:t.turns||0};this.properties.turns<0;)this.properties.turns+=4;for(;this.properties.turns>=4;)this.properties.turns-=4;CLARITY.Filter.call(this,t)},CLARITY.Rotator.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Rotator.prototype.doProcess=function(t){if(0==this.properties.turns)return t;var e=t.width,r=t.height,a=0;if(1==this.properties.turns||3==this.properties.turns&&t.width!=t.height){var i=CLARITY.Operations.minimum([t.width,t.height]);i==t.width?(a=Math.floor((t.height-t.width)/2),r=i):(a=Math.floor((t.width-t.height)/2),e=i)}for(var o=CLARITY.ctx.createImageData(t.width,t.height),s=a;r+a>s;s++)for(var n=0;e>n;n++){var h,d,l=4*((s-a)*t.width+(n+a));1==this.properties.turns?(h=-s,d=n):2==this.properties.turns?(h=-n,d=-s):3==this.properties.turns&&(h=s,d=-n),h>t.width?h-=t.width:0>h&&(h+=t.width),d>t.height?d-=t.height:0>d&&(d+=t.height);var c=4*(d*t.width+h);o.data[c]=t.data[l],o.data[c+1]=t.data[l+1],o.data[c+2]=t.data[l+2],o.data[c+3]=255}return o},CLARITY.Rotator.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(-3,3,1,"Turns",this.properties.turns);return e.appendChild(r),r.addEventListener("change",function(e){t.setInt("turns",e.srcElement.value)}),e},CLARITY.Tiler=function(t){var t=t||{};CLARITY.Filter.call(this,t)},CLARITY.Tiler.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Tiler.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.height;r+=2)for(var a=0;a<t.width;a+=2){var i=4*(r*t.width+a),o=4*(r*t.width+a+1),s=4*((r+1)*t.width+a),n=4*((r+1)*t.width+a+1),h=a/2,d=r/2,l=4*(d*t.width+h);e.data[l]=t.data[i],e.data[l+1]=t.data[i+1],e.data[l+2]=t.data[i+2],e.data[l+3]=255,h=t.width-a/2-1,d=r/2,l=4*(d*t.width+h),e.data[l]=t.data[o],e.data[l+1]=t.data[o+1],e.data[l+2]=t.data[o+2],e.data[l+3]=255,h=a/2,d=t.height-r/2-1,l=4*(d*t.width+h),e.data[l]=t.data[s],e.data[l+1]=t.data[s+1],e.data[l+2]=t.data[s+2],e.data[l+3]=255,h=t.width-a/2-1,d=t.height-r/2-1,l=4*(d*t.width+h),e.data[l]=t.data[n],e.data[l+1]=t.data[n+1],e.data[l+2]=t.data[n+2],e.data[l+3]=255}return e},CLARITY.Translator=function(t){var t=t||{};this.properties={horizontal:CLARITY.Operations.clamp(t.horizontal||.5,-1,1),verticle:CLARITY.Operations.clamp(t.verticle||.5,-1,1)},CLARITY.Filter.call(this,t)},CLARITY.Translator.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Translator.prototype.doProcess=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=Math.ceil(t.width*this.properties.horizontal),a=Math.ceil(t.height*this.properties.verticle),i=0;i<t.height;i++)for(var o=0;o<t.width;o++){var s=4*(i*t.width+o),n=o+r,h=i+a;n>t.width?n-=t.width:0>n&&(n+=t.width),h>t.height?h-=t.height:0>h&&(h+=t.height);var d=4*(h*t.width+n);e.data[d]=t.data[s],e.data[d+1]=t.data[s+1],e.data[d+2]=t.data[s+2],e.data[d+3]=255}return e},CLARITY.Translator.prototype.doCreateControls=function(){var t=this,e=CLARITY.Interface.createDiv(),r=CLARITY.Interface.createSlider(0,1,.01,"Vertical",this.properties.vertical);return e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("verticle",e.srcElement.value)}),r=CLARITY.Interface.createSlider(0,1,.01,"Horizontal",this.properties.horizontal),e.appendChild(r),r.addEventListener("change",function(e){t.setFloat("horizontal",e.srcElement.value)}),e};