var CLARITY={ctx:document.createElement("canvas").getContext("2d")};CLARITY.Filter=function(t){var t=t||{};this.channel=t.channel||"grey"},CLARITY.Filter.prototype={process:function(t){return t},getColourValue:function(t,e,r){var r=r||this.channel||"grey";switch(r){case"grey":return.2989*t.data[e+0]+.587*t.data[e+1]+.114*t.data[e+2];case"red":case"r":return t.data[e+0];case"green":case"g":return t.data[e+1];case"blue":case"b":return t.data[e+2];default:return.2989*t.data[e+0]+.587*t.data[e+1]+.114*t.data[e+2]}},setFloat:function(t,e){this.properties[t]=parseFloat(e)},setInt:function(t,e){this.properties[t]=parseInt(e)},toggleBool:function(t){this.properties[t]=!this.properties[t]}},CLARITY.Filter.prototype.createControls=function(t){var e=CLARITY.Interface.createControlGroup(t);return label=CLARITY.Interface.createLabel("No options."),e.appendChild(label),e},CLARITY.MCut=function(){function t(){function e(){var t,e=[{min:Number.MAX_VALUE,max:Number.MIN_VALUE},{min:Number.MAX_VALUE,max:Number.MIN_VALUE},{min:Number.MAX_VALUE,max:Number.MIN_VALUE}];for(t=f.length-1;t>=0;t-=1)e[0].min=f[t][0]<e[0].min?f[t][0]:e[0].min,e[1].min=f[t][1]<e[1].min?f[t][1]:e[1].min,e[2].min=f[t][2]<e[2].min?f[t][2]:e[2].min,e[0].max=f[t][0]>e[0].max?f[t][0]:e[0].max,e[1].max=f[t][1]>e[1].max?f[t][1]:e[1].max,e[2].max=f[t][2]>e[2].max?f[t][2]:e[2].max;return e}function r(t){f=t,g=3,C=e()}function a(){return f}function i(){var t,e,r=0,a=0;for(t=g-1;t>=0;t-=1)e=C[t].max-C[t].min,e>a&&(r=t,a=e);return{axis:r,length:a}}function s(t){var e=function(e,r){return e[t]-r[t]};return e}function h(){var t=i().axis,e=s(t);return Array.prototype.sort.call(f,e),f}function o(){var t,e,r,a=0,s=Number.MAX_VALUE,h=i().axis;for(r=f.length-1;r>=0;r-=1)a+=f[r][h];for(a/=f.length,r=f.length-1;r>=0;r-=1)e=Math.abs(f[r][h]-a),s>e&&(s=e,t=r);return t}function n(){h();var e=o(),r=Array.prototype.slice.call(f,0,e),a=Array.prototype.slice.call(f,e),i=new t,s=new t;return i.init(r),s.init(a),[i,s]}function d(){var t,e=0,r=0,a=0;for(t=f.length-1;t>=0;t-=1)e+=f[t][0],r+=f[t][1],a+=f[t][2];return e/=f.length,r/=f.length,a/=f.length,[parseInt(e,10),parseInt(r,10),parseInt(a,10)]}function c(){return Math.floor(f.length/2)}function l(){return 0===f.length}function p(){return f.length>=2}function u(){return C}var f,C,g;return{get_data:a,median_pos:c,get_bounding_box:u,calculate_bounding_box:e,sort:h,get_comparison_func:s,mean_pos:o,split:n,is_empty:l,is_splittable:p,get_longest_axis:i,average:d,init:r}}function e(){"use strict";function e(e){var a=!1;if(r(e)){var i=new t;i.init(e),n=[i],a=!0}return a}function r(t){var e=t.length>0;return e}function a(t){var r=e(t);r&&(d=t)}function i(){var t,e=0;for(t=n.length-1;t>=0;t-=1)n[t]>e&&(e=n[t]);return e}function s(){return n}function h(t){var r,a,s,h,o,c,l,p,u,f;if(e(d),0===n.length)return[];a=[],h=i(),o=n[h].get_longest_axis(),c=o.length*(1-t);do l=n.splice(h,1)[0],p=l.split(),u=p[0],f=p[1],n.push(u),n.push(f),h=i(),o=n[h].get_longest_axis();while(o.length>c);for(s=0;s<n.length;s+=1)r=n[s].average(),isNaN(r[0])&&isNaN(r[0])&&isNaN(r[0])||a.push(n[s].average());return a}function o(t){var r,a,s,h,o=[];if(e(d),0===n.length)return[];for(r=t-1;r>=0;r-=1)a=i(),s=n.splice(a,1)[0],s.is_splittable()?(h=s.split(),n.push(h[0]),n.push(h[1])):(n.push(s),n.push(s));for(r=t-1;r>=0;r-=1)o.push(n[r].average());return o}var n=[],d=[];return{get_boxes:s,init:a,get_fixed_size_palette:o,get_dynamic_size_palette:h}}this.MCut=new e},CLARITY.Interface={createControlGroup:function(t){var e=document.createElement("div");if(e.setAttribute("class","clarity-controlGroup"),t){var r=document.createElement("h3");r.setAttribute("class","clarity-title"),r.innerHTML=t,e.appendChild(r)}return e},createSlider:function(t,e,r,a){var i=document.createElement("div");i.setAttribute("class","clarity-control");var s=document.createElement("input");if(s.setAttribute("class","clarity-slider"),s.setAttribute("type","range"),s.setAttribute("min",t||0),s.setAttribute("max",e||1),s.setAttribute("step",r||1),a){var h=document.createElement("label");h.setAttribute("class","clarity-label"),h.innerHTML=a,i.appendChild(h)}return i.appendChild(s),i},createToggle:function(t,e){var r=document.createElement("div");r.setAttribute("class","clarity-control");var a=document.createElement("input");if(a.setAttribute("class","clarity-checkbox"),a.setAttribute("type","checkbox"),t&&a.setAttribute("checked",!0),e){var i=document.createElement("label");i.setAttribute("class","clarity-label"),i.innerHTML=e,r.appendChild(i)}return r.appendChild(a),r},createBreak:function(){var t=document.createElement("br");return t},createLabel:function(t){var e=document.createElement("div");e.setAttribute("class","clarity-control");var r=document.createElement("label");return r.setAttribute("class","clarity-label"),r.innerHTML=t,e.appendChild(r),e}},CLARITY.Operations={RGBtoHSV:function(t){var e,r,a,i;e=t[0]/255,r=t[1]/255,a=t[2]/255;var s=this.minimum([e,r,a]),h=this.maximum([e,r,a]);if(s==h)return computedV=s,[0,0,computedV];var o=e==s?r-a:a==s?e-r:a-e,i=e==s?3:a==s?1:5;return computedH=60*(i-o/(h-s)),computedS=(h-s)/h,computedV=h,[computedH,computedS,computedV]},HSVtoRGB:function(t){var e,r,a,i;r=t[0],a=t[1],i=t[2];var e=r/60,s=i*a,h=s*(1-Math.abs(e%2-1)),o=i-s;switch(e=Math.floor(e)){case 0:case 6:return[255*(s+o),255*(h+o),255*(0+o)];case 1:return[255*(h+o),255*(s+o),255*(0+o)];case 2:return[255*(0+o),255*(s+o),255*(h+o)];case 3:return[255*(0+o),255*(h+o),255*(s+o)];case 4:return[255*(h+o),255*(0+o),255*(s+o)];default:return[255*(s+o),255*(0+o),255*(h+o)]}},minimum:function(t){for(var e=1e7,r=0;r<t.length;r++)t[r]<e&&(e=t[r]);return e},maximum:function(t){for(var e=-1e6,r=0;r<t.length;r++)t[r]>e&&(e=t[r]);return e},clamp:function(t,e,r){return e>t?e:t>r?r:t},colorDistance:function(t,e){this.colourDistance(t,e)},colourDistance:function(t,e){return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2)}},CLARITY.Pixel=function(t,e,r){this.r=0,this.g=0,this.b=0,this.h=0,this.s=0,this.v=0,this.setFromRGB(t,e,r)},CLARITY.Pixel.prototype={getColourValue:function(t){var t=this.channel||t||"grey";switch(t){case"grey":return.2989*this.r+.587*this.g+.114*this.b;case"red":case"r":return this.r;case"green":case"g":return this.g;case"blue":case"b":return this.b;case"hue":case"h":return this.h;case"saturation":case"s":return this.s;case"value":case"v":return this.v;default:return.2989*this.r+.587*this.g+.114*this.b}},setFromRGB:function(t,e,r){var a,i,s;return this.r=t,this.g=e,this.b=r,a=minimum([this.r,this.g,this.b]),i=maximum([this.r,this.g,this.b]),this.v=i,s=i-a,0==i?(this.s=0,void(this.h=-1)):(this.s=s/i,this.h=this.r==i?(this.g-this.b)/s:this.g==i?2+(this.b-this.r)/s:4+(this.r-this.g)/s,this.h*=60,void(this.h<0&&(this.h+=360)))},setFromHSV:function(t,e,r){var a,i,s,h,o;if(this.h=t,this.s=e,this.v=r,0==this.s)return void(this.r=this.g=this.b=this.v);switch(a=Math.floor(this.h/60),i=this.h-a,s=this.v*(1-this.s),h=this.v*(1-this.s*i),o=this.v*(1-this.s*(1-i)),a){case 0:this.r=r,this.g=o,this.b=s;break;case 1:this.r=h,this.g=r,this.b=s;break;case 2:this.r=s,this.g=r,this.b=o;break;case 3:this.r=s,this.g=h,this.b=r;break;case 4:this.r=o,this.g=s,this.b=r;break;default:this.r=r,this.g=s,this.b=h}}},CLARITY.Contourer=function(t){var t=t||{};this.contours=t.contours||10,this.threshes=[128,256],this.threshSets=[0,256],this.difference=128,this.maxValue=0,this.minValue=255,CLARITY.Filter.call(this,t)},CLARITY.Contourer.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Contourer.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.data.length;r+=4)t.data[r]>this.maxValue?this.maxValue=t.data[r]:t.data[r]<this.minValue&&(this.minValue=t.data[r]);this.setVar(this.contours);for(var r=0;r<t.data.length;r++)if((r+1)%4!=0){for(var a=0;a<this.threshes.length;a++)if(t.data[r]<this.threshes[a]){e.data[r]=this.threshSets[a];break}}else e.data[r]=255;return e},CLARITY.Contourer.prototype.setVar=function(t){this.threshes=[],this.difference=(this.maxValue-this.minValue)/t;for(var e=0,r=this.difference+this.minValue;256>=r;r+=this.difference)this.threshes[e]=r,this.threshSets[e]=(r-this.difference-this.minValue)/(this.maxValue-this.minValue)*255,e++;this.threshes[e]=r,this.threshSets[e]=255},CLARITY.NormalEditor=function(t){var t=t||{};this.intensity=t.intensity||.5,CLARITY.Filter.call(this,t)},CLARITY.NormalEditor.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.NormalEditor.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=1;r<t.height-1;r++)for(var a=1;a<t.width-1;a++){var i=4*(r*t.width+a),s={x:(t.data[i]-128)/128,y:(t.data[i+1]-128)/128,z:t.data[i+2]/255};s=this.normalise(s),s.x*=this.intensity,s.y*=this.intensity,s=this.normalise(s),e.data[i]=128*(s.x+1),e.data[i+1]=128*(s.y+1),e.data[i+2]=255*s.z,e.data[i+3]=255}return e},CLARITY.NormalEditor.prototype.normalise=function(t){var e=Math.sqrt(Math.abs(t.x*t.x+t.y*t.y+t.z*t.z));return{x:t.x/e,y:t.y/e,z:t.z/e}},CLARITY.NormalGenerator=function(t){var t=t||{};this.heightMod=t.heightMod||.15,CLARITY.Filter.call(this,t)},CLARITY.NormalGenerator.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.NormalGenerator.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=1;r<t.height-1;r++)for(var a=1;a<t.width-1;a++){var i=4*(r*t.width+a),s=4*((r-1)*t.width+a),h=4*((r+1)*t.width+a),o=4*(r*t.width+(a-1)),n=4*(r*t.width+(a+1)),d={x:a,y:r,z:this.heightMod*t.data[i]},c={x:a,y:r-1,z:this.heightMod*t.data[s]},l={x:a,y:r+1,z:this.heightMod*t.data[h]},p={x:a-1,y:r,z:this.heightMod*t.data[o]},u={x:a+1,y:r,z:this.heightMod*t.data[n]},f=this.generateNormal(d,p,u,c,l);e.data[i]=255-(f.x/2+128),e.data[i+1]=255-(f.y/2+128),e.data[i+2]=-f.z,e.data[i+3]=255}return e},CLARITY.NormalGenerator.prototype.generateNormal=function(t,e,r,a,i){var s=this.calcNormal(t,a,e),h=this.calcNormal(t,e,i),o=this.calcNormal(t,i,r),n=this.calcNormal(t,r,a),d=this.average(s,h,o,n);return d},CLARITY.NormalGenerator.prototype.calcNormal=function(t,e,r){var a=this.vectorSub(t,e),i=this.vectorSub(t,r),s=this.crossProduct(a,i);return s=this.normalise(s)},CLARITY.NormalGenerator.prototype.vectorSub=function(t,e){return{x:t.x-e.x,y:t.y-e.y,z:t.z-e.z}},CLARITY.NormalGenerator.prototype.vectorAdd=function(t,e){return{x:t.x+e.x,y:t.y+e.y,z:t.z+e.z}},CLARITY.NormalGenerator.prototype.crossProduct=function(t,e){return{x:t.y*e.z-t.z*e.y,y:-(t.x*e.z-t.z*e.x),z:t.x*e.y-t.y*e.x}},CLARITY.NormalGenerator.prototype.normalise=function(t){var e=Math.sqrt(Math.abs(t.x*t.x+t.y*t.y+t.z*t.z));return{x:t.x/e,y:t.y/e,z:t.z/e}},CLARITY.NormalGenerator.prototype.average=function(t,e,r,a){var i=this.vectorAdd(t,e);return i=this.vectorAdd(i,r),i=this.vectorAdd(i,a),i=this.normalise(i),{x:255*i.x,y:255*i.y,z:255*i.z}},CLARITY.DifferenceDetector=function(t){var t=t||{};this.original=null,CLARITY.Filter.call(this,t)},CLARITY.DifferenceDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DifferenceDetector.prototype.process=function(t){if(!this.original)return this.original=t,t;for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.width*t.height*4;r+=4){var a=[this.original.data[r],this.original.data[r+1],this.original.data[r+2]],i=[t.data[r],t.data[r+1],t.data[r+2]];findDifference(i,a)?(e.data[r]=t.data[r],e.data[r+1]=t.data[r+1],e.data[r+2]=t.data[r+2],e.data[r+3]=255):(e.data[r]=0,e.data[r+1]=0,e.data[r+2]=0,e.data[r+3]=255)}return e},CLARITY.DifferenceDetector.prototype.resetOriginal=function(){this.original=null},CLARITY.DifferenceDetector.prototype.findDifference=function(t,e){return t[0]<e[0]+75&&t[0]>e[0]-75&&t[1]<e[1]+75&&t[1]>e[1]-75&&t[2]<e[2]+75&&t[2]>e[2]-75?!1:!0},CLARITY.Ghoster=function(t){var t=t||{};this.length=t.length||10,this.frames=new Array,CLARITY.Filter.call(this,t)},CLARITY.Ghoster.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Ghoster.prototype.process=function(t){this.frames.unshift(t),this.frames.length>this.length&&this.frames.pop();for(var e=CLARITY.ctx.createImageData(width,height),r=0;r<t.data.length;r+=4){for(var a=0;a<this.frames.length;a++)e.data[r]+=this.frames[a].data[r]/this.frames.length*(a/this.frames.length)*2,e.data[r+1]+=this.frames[a].data[r+1]/this.frames.length*(a/this.frames.length)*2,e.data[r+2]+=this.frames[a].data[r+2]/this.frames.length*(a/this.frames.length)*2;e.data[r+3]=255}return e},CLARITY.Puzzler=function(t){var t=t||{};this.width=t.width||640,this.height=t.height||480,this.selected=null,this.splits=t.splits||8,this.swaps=[];for(var e=0,r=0;r<this.splits;r++){this.swaps[r]=[];for(var a=0;a<this.splits;a++)this.swaps[r][a]=e++}for(var r=0;r<10*this.splits;r++){var i=Math.floor(Math.random()*this.splits),s=Math.floor(Math.random()*this.splits),h=Math.floor(Math.random()*this.splits),o=Math.floor(Math.random()*this.splits),n=this.swaps[i][s];this.swaps[i][s]=this.swaps[h][o],this.swaps[h][o]=n}CLARITY.Filter.call(this,t)},CLARITY.Puzzler.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Puzzler.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=this.height/this.splits,a=this.width/this.splits,i=0;i<this.splits;i++)for(var s=0;s<this.splits;s++)for(var h=this.numToPos(this.swaps[s][i]),o=0;r>o;o++)for(var n=0;a>n;n++){var d=4*((i*r+o)*t.width+(s*a+n)),c=4*((h[1]*r+o)*t.width+(h[0]*a+n)),l=this.getPixel(t.data,c);e.data[d]=l[0],e.data[d+1]=l[1],e.data[d+2]=l[2],e.data[d+3]=255}if(void 0!=this.selected)for(var i=0;i<this.height/this.splits;i++)for(var s=0;s<this.width/this.splits;s++){var d=4*((this.selected[1]*(this.height/this.splits)+i)*this.width+(this.selected[0]*(this.width/this.splits)+s));e.data[d+2]+=80}return e},CLARITY.Puzzler.prototype.getPixel=function(t,e){return[t[e],t[e+1],t[e+2]]},CLARITY.Puzzler.prototype.setPixel=function(t,e,r,a){var i=4*(r*this.width+e);t.data[i]=a[0],t.data[i+1]=a[1],t.data[i+2]=a[2]},CLARITY.Puzzler.prototype.setClick=function(t){var e=Math.floor(t[0]/(this.width/this.splits)),r=Math.floor(t[1]/(this.height/this.splits));if(this.selected){var a=this.swaps[this.selected[0]][this.selected[1]];this.swaps[this.selected[0]][this.selected[1]]=this.swaps[e][r],this.swaps[e][r]=a,this.selected=void 0}else this.selected=[e,r]},CLARITY.Puzzler.prototype.numToPos=function(t){for(var e=0,r=0;t>this.splits-1;)t-=this.splits,e++;return r=t,[e,r]},CLARITY.GradientThreshold=function(t){var t=t||{};this.properties={thresh:t.thresh||20,distance:t.distance||1},CLARITY.Filter.call(this,t)},CLARITY.GradientThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.GradientThreshold.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=!1,a=this.properties.distance;a<t.height-this.properties.distance;a++)for(var i=this.properties.distance;i<t.width-this.properties.distance;i++){r=!1;var s=4*(a*t.width+i),h=4*((a-this.properties.distance)*t.width+i),o=4*((a+this.properties.distance)*t.width+i),n=4*(a*t.width+(i-this.properties.distance)),d=4*(a*t.width+(i+this.properties.distance));t.data[s]<t.data[n]-this.properties.thresh?r=!0:t.data[s]>t.data[n]+this.properties.thresh?r=!0:t.data[s]<t.data[d]-this.properties.thresh?r=!0:t.data[s]>t.data[d]+this.properties.thresh?r=!0:t.data[s]<t.data[h]-this.properties.thresh?r=!0:t.data[s]>t.data[h]+this.properties.thresh?r=!0:t.data[s]<t.data[o]-this.properties.thresh?r=!0:t.data[s]>t.data[o]+this.properties.thresh&&(r=!0),r?(e.data[s+0]=255,e.data[s+1]=255,e.data[s+2]=255,e.data[s+3]=255):(e.data[s+0]=0,e.data[s+1]=0,e.data[s+2]=0,e.data[s+3]=255)}return e},CLARITY.GradientThreshold.prototype.createControls=function(t){var e=this,r=CLARITY.Interface.createControlGroup(t),a=CLARITY.Interface.createSlider(0,100,1,"Threshold");return r.appendChild(a),a.addEventListener("change",function(t){e.setFloat("thresh",t.srcElement.value)}),a=CLARITY.Interface.createSlider(0,10,1,"Distance"),r.appendChild(a),a.addEventListener("change",function(t){e.setFloat("distance",t.srcElement.value)}),r},CLARITY.MedianThreshold=function(t){CLARITY.Filter.call(this,t)},CLARITY.MedianThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MedianThreshold.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);this.threshes=this.getThresholdValues(t),this.threshes.push(256);for(var r=0;r<t.data.length;r++)if((r+1)%4!=0){for(var a=0;a<this.threshes.length;a++)if(t.data[r]<this.threshes[a]){e.data[r]=this.threshes[a];break}}else e.data[r]=255;return e},CLARITY.MedianThreshold.prototype.getThresholdValues=function(t){for(var e=new Array,r=[0,0,0],a=0;256>a;a++)e[a]=0;for(var a=0;a<t.data.length;a+=4)e[t.data[a]]++;for(var i=0,s=t.data.length/4/4,h=0,a=0;256>a;a++)i+=e[a],i>s&&(s+=t.data.length/4/4,r[h]=a,h++);return r},CLARITY.ValueThreshold=function(t){var t=t||{};this.properties={inverted:t.inverted||!1,thresh:t.thresh||null},CLARITY.Filter.call(this,t)},CLARITY.ValueThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.ValueThreshold.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=this.properties.thresh||this.getThresholdValue(t),a=0;a<t.width*t.height*4;a+=4){var i=this.getColourValue(t,a,this.channel);this.properties.inverted?r>i?(e.data[a+0]=255,e.data[a+1]=255,e.data[a+2]=255):(e.data[a+0]=0,e.data[a+1]=0,e.data[a+2]=0):i>r?(e.data[a+0]=255,e.data[a+1]=255,e.data[a+2]=255):(e.data[a+0]=0,e.data[a+1]=0,e.data[a+2]=0),e.data[a+3]=255}return e},CLARITY.ValueThreshold.prototype.getThresholdValue=function(t){var e;e=this.getColourValue(t,0);for(var r=4;r<t.width*t.height*4;r+=4){var a=this.getColourValue(t,r);e=(e+a)/2}for(var i=0,s=0,h=0,o=e;!(h>o-1&&o+1>h);){h=o;for(var r=0;r<t.width*t.height*4;r+=4){var a=this.getColourValue(t,r);h>a?i=0==i?a:(i+a)/2:s=0==s?a:(s+a)/2}o=(s+i)/2,i=0,s=0}return o},CLARITY.ValueThreshold.prototype.createControls=function(t){var e=this,r=CLARITY.Interface.createControlGroup(t),a=CLARITY.Interface.createToggle(this.properties.inverted,"Inverted");r.appendChild(a),a.addEventListener("change",function(){e.toggleBool("inverted")});var i=CLARITY.Interface.createSlider(0,255,1,"Threshold");return r.appendChild(i),i.addEventListener("change",function(t){e.setFloat("thresh",t.srcElement.value)}),r},CLARITY.EdgeDetector=function(t){var t=t||{};this.fast=t.fast||!1,this.channel=t.channel||"grey",this.kernel=[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],CLARITY.Filter.call(this,t)},CLARITY.EdgeDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.EdgeDetector.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);if(this.fast)for(var r=4;r<4*t.height-4;r+=4)for(var a=4;a<4*t.width-4;a+=4){var i=r*t.width+a;e.data[i]=5*Math.abs(this.getColourValue(t,i+4)-this.getColourValue(t,i)),e.data[i+1]=5*Math.abs(this.getColourValue(t,i+4)-this.getColourValue(t,i)),e.data[i+2]=5*Math.abs(this.getColourValue(t,i+4)-this.getColourValue(t,i)),e.data[i+3]=255}else for(var r=4;r<4*t.height-4;r+=4)for(var a=4;a<4*t.width-4;a+=4){for(var s=0,h=-1;1>=h;h++)for(var o=-1;1>=o;o++){var n=(r+4*h)*t.width+(a+4*o),d=this.getColourValue(t,n);s+=this.kernel[h+1][o+1]*d}e.data[r*t.width+a]=s,e.data[r*t.width+a+1]=s,e.data[r*t.width+a+2]=s,e.data[r*t.width+a+3]=255}return e},CLARITY.MotionDetector=function(t){this.frames=[],this.index=0,this.properties={frameCount:t.frameCount||1},this.preindex=this.properties.frameCount,CLARITY.Filter.call(this,t)},CLARITY.MotionDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MotionDetector.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);if(this.pushFrame(t),this.frames.length<this.properties.frameCount+1)return e;for(var r=0;r<t.width*t.height*4;r+=4)e.data[r+0]=Math.abs(this.getColourValue(this.frames[this.preindex],r)-this.getColourValue(this.frames[this.index],r)),e.data[r+1]=Math.abs(this.getColourValue(this.frames[this.preindex],r)-this.getColourValue(this.frames[this.index],r)),e.data[r+2]=Math.abs(this.getColourValue(this.frames[this.preindex],r)-this.getColourValue(this.frames[this.index],r)),e.data[r+3]=255;return e},CLARITY.MotionDetector.prototype.pushFrame=function(t){this.frames[this.index]=CLARITY.ctx.createImageData(t.width,t.height);for(var e=0;e<t.data.length;e++)this.frames[this.index].data[e]=t.data[e];this.index++,this.index>this.properties.frameCount&&(this.index=0),this.preindex++,this.preindex>this.properties.frameCount&&(this.preindex=0)},CLARITY.MotionDetector.prototype.createControls=function(t){var e=this,r=CLARITY.Interface.createControlGroup(t),a=CLARITY.Interface.createSlider(1,24,1,"Frame Count");return r.appendChild(a),a.addEventListener("change",function(t){e.setInt("frameCount",t.srcElement.value),e.index=0,e.preindex=t.srcElement.value-1,e.frames=[]}),r},CLARITY.SkinDetector=function(t){var t=t||{};CLARITY.Filter.call(this,t)},CLARITY.SkinDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.SkinDetector.prototype.process=function(t){var e=CLARITY.ctx.createImageData(t.width,t.height);this.RGBAtoYCbCr(e,t);for(var r=0;r<t.width*t.height*4;r+=4)e.data[r+0]=e.data[r]>30?255:0,e.data[r+1]=80<e.data[r+1]&&e.data[r+1]<121?255:0,e.data[r+2]=133<e.data[r+2]&&e.data[r+2]<173?255:0,e.data[r+3]=255;return e},CLARITY.SkinDetector.prototype.RGBAtoYCbCr=function(t,e){for(var r,a,i,s=0;s<e.width*e.height*4;s+=4)r=16+(66*e.data[s]+129*e.data[s+1]+25*e.data[s+2])/256,a=128+(-38*e.data[s]-74*e.data[s+1]+112*e.data[s+2])/256,i=128+(112*e.data[s]-94*e.data[s+1]-18*e.data[s+2])/256,t.data[s]=r,t.data[s+1]=a,t.data[s+2]=i},CLARITY.Mirror=function(t){var t=t||{};this.properties={Horizontal:t.Horizontal||!0,Vertical:t.Vertical||!1},CLARITY.Filter.call(this,t)},CLARITY.Mirror.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Mirror.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.height;r++)for(var a=0;a<t.width;a++){var i=4*(r*t.width+a),s=a,h=r;this.properties.Horizontal&&(s=t.width-a),this.properties.Vertical&&(h=t.height-r);var o=4*(h*t.width+s);e.data[o]=t.data[i],e.data[o+1]=t.data[i+1],e.data[o+2]=t.data[i+2],e.data[o+3]=255}return e},CLARITY.Mirror.prototype.createControls=function(t){var e=this,r=CLARITY.Interface.createControlGroup(t),a=CLARITY.Interface.createToggle(this.properties.Vertical,"Vertical");return r.appendChild(a),a.addEventListener("change",function(){e.toggleBool("Vertical")}),a=CLARITY.Interface.createToggle(this.properties.Horizontal,"Horizontal"),r.appendChild(a),a.addEventListener("change",function(){e.toggleBool("Horizontal")}),r},CLARITY.Rotator=function(t){var t=t||{};for(this.properties={turns:t.turns||0};this.properties.turns<0;)this.properties.turns+=4;for(;this.properties.turns>=4;)this.properties.turns-=4;CLARITY.Filter.call(this,t)},CLARITY.Rotator.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Rotator.prototype.process=function(t){if(0==this.properties.turns)return t;var e=t.width,r=t.height,a=0;if(1==this.properties.turns||3==this.properties.turns&&t.width!=t.height){var i=CLARITY.Operations.minimum([t.width,t.height]);i==t.width?(a=Math.floor((t.height-t.width)/2),r=i):(a=Math.floor((t.width-t.height)/2),e=i)}for(var s=CLARITY.ctx.createImageData(t.width,t.height),h=a;r+a>h;h++)for(var o=0;e>o;o++){var n,d,c=4*((h-a)*t.width+(o+a));1==this.properties.turns?(n=-h,d=o):2==this.properties.turns?(n=-o,d=-h):3==this.properties.turns&&(n=h,d=-o),n>t.width?n-=t.width:0>n&&(n+=t.width),d>t.height?d-=t.height:0>d&&(d+=t.height);var l=4*(d*t.width+n);s.data[l]=t.data[c],s.data[l+1]=t.data[c+1],s.data[l+2]=t.data[c+2],s.data[l+3]=255}return s},CLARITY.Rotator.prototype.createControls=function(t){var e=this,r=CLARITY.Interface.createControlGroup(t),a=CLARITY.Interface.createSlider(-3,3,1,"Turns");return r.appendChild(a),a.addEventListener("change",function(t){e.setInt("turns",t.srcElement.value)}),r},CLARITY.Tiler=function(t){var t=t||{};CLARITY.Filter.call(this,t)},CLARITY.Tiler.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Tiler.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.height;r+=2)for(var a=0;a<t.width;a+=2){var i=4*(r*t.width+a),s=a/2,h=r/2,o=4*(h*t.width+s);e.data[o]=t.data[i],e.data[o+1]=t.data[i+1],e.data[o+2]=t.data[i+2],e.data[o+3]=255,s=t.width-a/2-1,h=r/2,o=4*(h*t.width+s),e.data[o]=t.data[i],e.data[o+1]=t.data[i+1],e.data[o+2]=t.data[i+2],e.data[o+3]=255,s=a/2,h=t.height-r/2-1,o=4*(h*t.width+s),e.data[o]=t.data[i],e.data[o+1]=t.data[i+1],e.data[o+2]=t.data[i+2],e.data[o+3]=255,s=t.width-a/2-1,h=t.height-r/2-1,o=4*(h*t.width+s),e.data[o]=t.data[i],e.data[o+1]=t.data[i+1],e.data[o+2]=t.data[i+2],e.data[o+3]=255}return e},CLARITY.Tiler.prototype.createControls=function(t){var e=CLARITY.Interface.createControlGroup(t);return label=CLARITY.Interface.createLabel("No options."),e.appendChild(label),e},CLARITY.Translator=function(t){var t=t||{};this.properties={xTrans:CLARITY.Operations.clamp(t.xTrans||.5,-1,1),yTrans:CLARITY.Operations.clamp(t.yTrans||.5,-1,1)},CLARITY.Filter.call(this,t)},CLARITY.Translator.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Translator.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=Math.ceil(t.width*this.properties.xTrans),a=Math.ceil(t.height*this.properties.yTrans),i=0;i<t.height;i++)for(var s=0;s<t.width;s++){var h=4*(i*t.width+s),o=s+r,n=i+a;o>t.width?o-=t.width:0>o&&(o+=t.width),n>t.height?n-=t.height:0>n&&(n+=t.height);var d=4*(n*t.width+o);e.data[d]=t.data[h],e.data[d+1]=t.data[h+1],e.data[d+2]=t.data[h+2],e.data[d+3]=255}return e},CLARITY.Translator.prototype.createControls=function(t){var e=this,r=CLARITY.Interface.createControlGroup(t),a=CLARITY.Interface.createSlider(0,1,.01,"Vertical");return r.appendChild(a),a.addEventListener("change",function(t){e.setFloat("yTrans",t.srcElement.value)}),a=CLARITY.Interface.createSlider(0,1,.01,"Horizontal"),r.appendChild(a),a.addEventListener("change",function(t){e.setFloat("xTrans",t.srcElement.value)}),r},CLARITY.Desaturate=function(t){var t=t||{};CLARITY.Filter.call(this,t)},CLARITY.Desaturate.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Desaturate.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.width*t.height*4;r+=4){var a=this.getColourValue(t,r,"grey");e.data[r+0]=a,e.data[r+1]=a,e.data[r+2]=a,e.data[r+3]=255}return e},CLARITY.DotRemover=function(t){var t=t||{};this.neighboursReq=t.neighboursReq||1,CLARITY.Filter.call(this,t)},CLARITY.DotRemover.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DotRemover.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=1;r<t.height-1;r++)for(var a=1;a<t.width-1;a++){var i=4*(r*t.width+a),s=4*((r-1)*t.width+a),h=4*((r+1)*t.width+a),o=4*(r*t.width+(a-1)),n=4*(r*t.width+(a+1)),d=t.data[i],c=0;t.data[s]==d&&c++,t.data[h]==d&&c++,t.data[o]==d&&c++,t.data[n]==d&&c++,c<=this.neighboursReq?d>138?(e.data[i]=0,e.data[i+1]=0,e.data[i+2]=0):(e.data[i]=255,e.data[i+1]=255,e.data[i+2]=255):(e.data[i]=d,e.data[i+1]=d,e.data[i+2]=d),e.data[i+3]=255}return e},CLARITY.hsvShifter=function(t){var t=t||{};this.properties={hue:t.hue||0,saturation:t.saturation||1,value:t.value||t.lightness||1},CLARITY.Filter.call(this,t)},CLARITY.hsvShifter.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.hsvShifter.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.width*t.height*4;r+=4){var a=CLARITY.Operations.RGBtoHSV([t.data[r],t.data[r+1],t.data[r+2]]);a[0]+=this.properties.hue,a[0]>360&&(a[0]-=360),a[1]*=this.properties.saturation,a[2]*=this.properties.value,a=CLARITY.Operations.HSVtoRGB([a[0],a[1],a[2]]),e.data[r+0]=a[0],e.data[r+1]=a[1],e.data[r+2]=a[2],e.data[r+3]=255}return e},CLARITY.hsvShifter.prototype.createControls=function(t){var e=this,r=CLARITY.Interface.createControlGroup(t),a=CLARITY.Interface.createSlider(0,360,1,"hue");return r.appendChild(a),a.addEventListener("change",function(t){e.setFloat("hue",t.srcElement.value)}),a=CLARITY.Interface.createSlider(0,2,.1,"saturation"),r.appendChild(a),a.addEventListener("change",function(t){e.setFloat("saturation",t.srcElement.value)}),a=CLARITY.Interface.createSlider(0,2,.1,"lightness"),r.appendChild(a),a.addEventListener("change",function(t){e.setFloat("value",t.srcElement.value)}),r},CLARITY.Posteriser=function(t){var t=t||{};this.method=t.method,"fast"==this.method?(this.threshes=[128,256],this.difference=32,this.setThresh(64)):(this.colours=t.colours||5,this.MCut=(new CLARITY.MCut).MCut),CLARITY.Filter.call(this,t)},CLARITY.Posteriser.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Posteriser.prototype.process=function(t){if("fast"==this.method)return this.oldMethod(t);for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=[],a=0;a<t.data.length;a+=4)r.push([t.data[a],t.data[a+1],t.data[a+2]]);this.MCut.init(r);for(var i,s,h=this.MCut.get_fixed_size_palette(this.colours),a=0;a<t.data.length;a+=4){var o,n=[t.data[a],t.data[a+1],t.data[a+2]];if(s&&i+5>o&&o>i-5)o=CLARITY.Operations.colourDistance(n,s),d=s;else{for(var d=h[0],c=CLARITY.Operations.colourDistance(n,d),l=1;l<h.length;l++)o=CLARITY.Operations.colourDistance(n,h[l]),c>o&&(c=o,d=h[l]);s=d,i=c}e.data[a]=d[0],e.data[a+1]=d[1],e.data[a+2]=d[2],e.data[a+3]=255}return e},CLARITY.Posteriser.prototype.oldMethod=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<t.data.length;r+=4)if((r+1)%4!=0){for(var a=0;a<this.threshes.length;a++)if(t.data[r]<this.threshes[a]){e.data[r]=this.threshes[a]-this.difference/2;break}}else e.data[r]=255;return e},CLARITY.Posteriser.prototype.setThresh=function(t){this.threshes=[],this.difference=t;for(var e=0,r=this.difference;256>=r;r+=this.difference)this.threshes[e]=r,e++;this.threshes[e]=r},CLARITY.Sharpen=function(t){var t=t||{};this.intensity=t.intensity||1,this.kernel=[[-this.intensity,-this.intensity,-this.intensity],[-this.intensity,8*this.intensity+1,-this.intensity],[-this.intensity,-this.intensity,-this.intensity]],CLARITY.Filter.call(this,t)},CLARITY.Sharpen.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Sharpen.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=4;r<4*t.height-4;r+=4)for(var a=4;a<4*t.width-4;a+=4){for(var i=0,s=0,h=0,o=-1;1>=o;o++)for(var n=-1;1>=n;n++){var d=(r+4*o)*t.width+(a+4*n),c=this.getColourValue(t,d,"red"),l=this.getColourValue(t,d,"green"),p=this.getColourValue(t,d,"blue");i+=this.kernel[o+1][n+1]*c,s+=this.kernel[o+1][n+1]*l,h+=this.kernel[o+1][n+1]*p}e.data[r*t.width+a]=i,e.data[r*t.width+a+1]=s,e.data[r*t.width+a+2]=h,e.data[r*t.width+a+3]=255}return e},CLARITY.Smoother=function(t){var t=t||{};this.distance=t.distance||1,this.iterations=t.iterations||1,CLARITY.Filter.call(this,t)},CLARITY.Smoother.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Smoother.prototype.process=function(t){for(var e=CLARITY.ctx.createImageData(t.width,t.height),r=0;r<this.iterations;r++)for(var a=this.distance;a<t.height-this.distance;a++)for(var i=this.distance;i<t.width-this.distance;i++){var s=4*(a*t.width+i),h=4*((a-this.distance)*t.width+i),o=4*((a+this.distance)*t.width+i),n=4*(a*t.width+(i-this.distance)),d=4*(a*t.width+(i+this.distance));e.data[s+0]=(t.data[n+0]+t.data[d+0]+t.data[h+0]+t.data[o+0])/4,e.data[s+1]=(t.data[n+1]+t.data[d+1]+t.data[h+1]+t.data[o+1])/4,e.data[s+2]=(t.data[n+2]+t.data[d+2]+t.data[h+2]+t.data[o+2])/4,e.data[s+3]=255}return e};