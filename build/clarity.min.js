var CLARITY={};CLARITY.Filter=function(t){var t=t||{};this.channel=t.channel||"grey"},CLARITY.Filter.prototype={ctx:document.createElement("canvas").getContext("2d"),process:function(t){return t},getColourValue:function(t,e,a){var a=this.channel||a||"grey";switch(a){case"grey":return.2989*t.data[e+0]+.587*t.data[e+1]+.114*t.data[e+2];case"red":return t.data[e+0];case"green":return t.data[e+1];case"blue":return t.data[e+2];default:return t.data[e+2]}}},CLARITY.DotRemover=function(t){var t=t||{};this.neighboursReq=t.neighboursReq||1,CLARITY.Filter.call(this,t)},CLARITY.DotRemover.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DotRemover.prototype.process=function(t){for(var e=this.ctx.createImageData(t.width,t.height),a=1;a<t.height-1;a++)for(var i=1;i<t.width-1;i++){var r=4*(a*t.width+i),h=4*((a-1)*t.width+i),s=4*((a+1)*t.width+i),o=4*(a*t.width+(i-1)),d=4*(a*t.width+(i+1)),n=t.data[r],l=0;t.data[h]==n&&l++,t.data[s]==n&&l++,t.data[o]==n&&l++,t.data[d]==n&&l++,l<=this.neighboursReq?n>138?(e.data[r]=0,e.data[r+1]=0,e.data[r+2]=0):(e.data[r]=255,e.data[r+1]=255,e.data[r+2]=255):(e.data[r]=n,e.data[r+1]=n,e.data[r+2]=n),e.data[r+3]=255}return e},CLARITY.Posteriser=function(t){this.threshes=[128,256],this.difference=32,this.setThresh(64),CLARITY.Filter.call(this,t)},CLARITY.Posteriser.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Posteriser.prototype.process=function(t){for(var e=ctx.createImageData(t.width,t.height),a=0;a<t.data.length;a++)if((a+1)%4!=0){for(var i=0;i<this.threshes.length;i++)if(t.data[a]<this.threshes[i]){e.data[a]=this.threshes[i]-this.difference/2;break}}else e.data[a]=255;return e},CLARITY.Posteriser.prototype.setThresh=function(t){this.threshes=[],this.difference=t;for(var e=0,a=this.difference;256>=a;a+=this.difference)this.threshes[e]=a,e++;this.threshes[e]=a},CLARITY.Smoother=function(t){var t=t||{};this.distance=t.distance||1,this.iterations=t.iterations||1,CLARITY.Filter.call(this,t)},CLARITY.Smoother.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Smoother.prototype.process=function(t){for(var e=ctx.createImageData(t.width,t.height),a=0;a<this.iterations;a++)for(var i=this.distance;i<t.height-this.distance;i++)for(var r=this.distance;r<t.width-this.distance;r++){var h=4*(i*t.width+r),s=4*((i-this.distance)*t.width+r),o=4*((i+this.distance)*t.width+r),d=4*(i*t.width+(r-this.distance)),n=4*(i*t.width+(r+this.distance));e.data[h+0]=(t.data[d+0]+t.data[n+0]+t.data[s+0]+t.data[o+0])/4,e.data[h+1]=(t.data[d+1]+t.data[n+1]+t.data[s+1]+t.data[o+1])/4,e.data[h+2]=(t.data[d+2]+t.data[n+2]+t.data[s+2]+t.data[o+2])/4,e.data[h+3]=255}return e},CLARITY.EdgeDetector=function(t){var t=t||{};this.fast=t.fast||!1,this.channel=t.channel||"grey",this.kernel=[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],CLARITY.Filter.call(this,t)},CLARITY.EdgeDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.EdgeDetector.prototype.process=function(t){var e=this.ctx.createImageData(t.width,t.height);if(this.fast)for(var a=4;a<4*t.height-4;a+=4)for(var i=4;i<4*t.width-4;i+=4){var r=a*t.width+i;e.data[r]=5*Math.abs(this.getColourValue(t,r+4)-this.getColourValue(t,r)),e.data[r+1]=5*Math.abs(this.getColourValue(t,r+4)-this.getColourValue(t,r)),e.data[r+2]=5*Math.abs(this.getColourValue(t,r+4)-this.getColourValue(t,r)),e.data[r+3]=255}else for(var a=4;a<4*t.height-4;a+=4)for(var i=4;i<4*t.width-4;i+=4){for(var h=0,s=-1;1>=s;s++)for(var o=-1;1>=o;o++){var d=(a+4*s)*t.width+(i+4*o),n=this.getColourValue(t,d);h+=this.kernel[s+1][o+1]*n}e.data[a*t.width+i]=h,e.data[a*t.width+i+1]=h,e.data[a*t.width+i+2]=h,e.data[a*t.width+i+3]=255}return e},CLARITY.MotionDetector=function(t){this.frames=[],this.frameNo=1,this.index=0,this.preindex=this.frameNo,CLARITY.Filter.call(this,t)},CLARITY.MotionDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MotionDetector.prototype.process=function(t){var e=this.ctx.createImageData(t.width,t.height);if(this.pushFrame(t),this.frames.length<this.frameNo+1)return e;for(var a=0;a<t.width*t.height*4;a+=4)e.data[a+0]=Math.abs(this.getColourValue(this.frames[this.preindex],a)-this.getColourValue(this.frames[this.index],a)),e.data[a+1]=Math.abs(this.getColourValue(this.frames[this.preindex],a)-this.getColourValue(this.frames[this.index],a)),e.data[a+2]=Math.abs(this.getColourValue(this.frames[this.preindex],a)-this.getColourValue(this.frames[this.index],a)),e.data[a+3]=255;return e},CLARITY.MotionDetector.prototype.pushFrame=function(t){this.frames[this.index]=ctx.createImageData(t.width,t.height);for(var e=0;e<t.data.length;e++)this.frames[this.index].data[e]=t.data[e];this.index++,this.index>this.frameNo&&(this.index=0),this.preindex++,this.preindex>this.frameNo&&(this.preindex=0)},CLARITY.SkinDetector=function(t){var t=t||{};this.componentised=t.componentised||!1,CLARITY.Filter.call(this,t)},CLARITY.SkinDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.SkinDetector.prototype.process=function(t){var e=this.ctx.createImageData(t.width,t.height);this.RGBAtoYCbCr(e,t);for(var a=0;a<t.width*t.height*4;a+=4)this.componentised?(e.data[a+0]=e.data[a]>30?255:0,e.data[a+1]=80<e.data[a+1]&&e.data[a+1]<121?255:0,e.data[a+2]=133<e.data[a+2]&&e.data[a+2]<173?255:0):e.data[a]>30&&80<e.data[a+1]&&e.data[a+1]<121&&133<e.data[a+2]&&e.data[a+2]<173?(e.data[a+0]=255,e.data[a+1]=255,e.data[a+2]=255):(e.data[a+0]=0,e.data[a+1]=0,e.data[a+2]=0),e.data[a+3]=255;return e},CLARITY.SkinDetector.prototype.RGBAtoYCbCr=function(t,e){for(var a,i,r,h=0;h<e.width*e.height*4;h+=4)a=16+(66*e.data[h]+129*e.data[h+1]+25*e.data[h+2])/256,i=128+(-38*e.data[h]-74*e.data[h+1]+112*e.data[h+2])/256,r=128+(112*e.data[h]-94*e.data[h+1]-18*e.data[h+2])/256,t.data[h]=a,t.data[h+1]=i,t.data[h+2]=r},CLARITY.AverageThreshold=function(t){var t=t||{};this.inverted=t.inverted||!1,this.thresh=t.thresh||null,CLARITY.Filter.call(this,t)},CLARITY.AverageThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.AverageThreshold.prototype.process=function(t){for(var e=this.ctx.createImageData(t.width,t.height),a=this.thresh||this.getThresholdValue(t),i=0;i<t.width*t.height*4;i+=4){var r=this.getColourValue(t,i,this.channel);this.inverted?a>r?(e.data[i+0]=255,e.data[i+1]=255,e.data[i+2]=255):(e.data[i+0]=0,e.data[i+1]=0,e.data[i+2]=0):r>a?(e.data[i+0]=255,e.data[i+1]=255,e.data[i+2]=255):(e.data[i+0]=0,e.data[i+1]=0,e.data[i+2]=0),e.data[i+3]=255}return e},CLARITY.AverageThreshold.prototype.getThresholdValue=function(t){log("Getting threshold value.");var e;e=this.getColourValue(t,0);for(var a=4;a<t.width*t.height*4;a+=4){var i=this.getColourValue(t,a);e=(e+i)/2}log("average "+e);for(var r=0,h=0,s=0,o=e;!(s>o-1&&o+1>s);){s=o,log("previous: "+s);for(var a=0;a<t.width*t.height*4;a+=4){var i=this.getColourValue(t,a);s>i?r=0==r?i:(r+i)/2:h=0==h?i:(h+i)/2}o=(h+r)/2,r=0,h=0,log("current: "+o)}return log("final: "+o),o},CLARITY.GradientThreshold=function(t){var t=t||{};this.thresh=t.thresh||20,this.distance=t.distance||1,CLARITY.Filter.call(this,t)},CLARITY.GradientThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.GradientThreshold.prototype.process=function(t){for(var e=this.ctx.createImageData(t.width,t.height),a=!1,i=this.distance;i<t.height-this.distance;i++)for(var r=this.distance;r<t.width-this.distance;r++){a=!1;var h=4*(i*t.width+r),s=4*((i-this.distance)*t.width+r),o=4*((i+this.distance)*t.width+r),d=4*(i*t.width+(r-this.distance)),n=4*(i*t.width+(r+this.distance));t.data[h]<t.data[d]-this.thresh?a=!0:t.data[h]>t.data[d]+this.thresh?a=!0:t.data[h]<t.data[n]-this.thresh?a=!0:t.data[h]>t.data[n]+this.thresh?a=!0:t.data[h]<t.data[s]-this.thresh?a=!0:t.data[h]>t.data[s]+this.thresh?a=!0:t.data[h]<t.data[o]-this.thresh?a=!0:t.data[h]>t.data[o]+this.thresh&&(a=!0),a?(e.data[h+0]=255,e.data[h+1]=255,e.data[h+2]=255,e.data[h+3]=255):(e.data[h+0]=0,e.data[h+1]=0,e.data[h+2]=0,e.data[h+3]=255)}return e},CLARITY.MedianThreshold=function(t){CLARITY.Filter.call(this,t)},CLARITY.MedianThreshold.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.MedianThreshold.prototype.process=function(t){var e=this.ctx.createImageData(t.width,t.height);this.threshes=this.getThresholdValues(t),this.threshes.push(256);for(var a=0;a<t.data.length;a++)if((a+1)%4!=0){for(var i=0;i<this.threshes.length;i++)if(t.data[a]<this.threshes[i]){e.data[a]=this.threshes[i];break}}else e.data[a]=255;return e},CLARITY.MedianThreshold.prototype.getThresholdValues=function(t){for(var e=new Array,a=[0,0,0],i=0;256>i;i++)e[i]=0;for(var i=0;i<t.data.length;i+=4)e[t.data[i]]++;for(var r=0,h=t.data.length/4/4,s=0,i=0;256>i;i++)r+=e[i],r>h&&(h+=t.data.length/4/4,a[s]=i,s++);return a},CLARITY.DifferenceDetector=function(t){var t=t||{};this.original=null,CLARITY.Filter.call(this,t)},CLARITY.DifferenceDetector.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.DifferenceDetector.prototype.process=function(t){if(!this.original)return this.original=t,t;for(var e=this.ctx.createImageData(t.width,t.height),a=0;a<t.width*t.height*4;a+=4){var i=[this.original.data[a],this.original.data[a+1],this.original.data[a+2]],r=[t.data[a],t.data[a+1],t.data[a+2]];findDifference(r,i)?(e.data[a]=t.data[a],e.data[a+1]=t.data[a+1],e.data[a+2]=t.data[a+2],e.data[a+3]=255):(e.data[a]=0,e.data[a+1]=0,e.data[a+2]=0,e.data[a+3]=255)}return e},CLARITY.DifferenceDetector.prototype.resetOriginal=function(){this.original=null},CLARITY.DifferenceDetector.prototype.findDifference=function(t,e){return t[0]<e[0]+75&&t[0]>e[0]-75&&t[1]<e[1]+75&&t[1]>e[1]-75&&t[2]<e[2]+75&&t[2]>e[2]-75?!1:!0},CLARITY.Contourer=function(t){var t=t||{};this.contours=t.contours||10,this.threshes=[128,256],this.threshSets=[0,256],this.difference=128,this.maxValue=0,this.minValue=255,CLARITY.Filter.call(this,t)},CLARITY.Contourer.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Contourer.prototype.process=function(t){for(var e=this.ctx.createImageData(t.width,t.height),a=0;a<t.data.length;a+=4)t.data[a]>this.maxValue?this.maxValue=t.data[a]:t.data[a]<this.minValue&&(this.minValue=t.data[a]);this.setVar(this.contours);for(var a=0;a<t.data.length;a++)if((a+1)%4!=0){for(var i=0;i<this.threshes.length;i++)if(t.data[a]<this.threshes[i]){e.data[a]=this.threshSets[i];break}}else e.data[a]=255;return e},CLARITY.Contourer.prototype.setVar=function(t){this.threshes=[],this.difference=(this.maxValue-this.minValue)/t;for(var e=0,a=this.difference+this.minValue;256>=a;a+=this.difference)this.threshes[e]=a,this.threshSets[e]=(a-this.difference-this.minValue)/(this.maxValue-this.minValue)*255,e++;this.threshes[e]=a,this.threshSets[e]=255},CLARITY.Ghoster=function(t){var t=t||{};this.length=t.length||10,this.frames=new Array,CLARITY.Filter.call(this,t)},CLARITY.Ghoster.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Ghoster.prototype.process=function(t){this.frames.unshift(t),this.frames.length>this.length&&this.frames.pop();for(var e=this.ctx.createImageData(width,height),a=0;a<t.data.length;a+=4){for(var i=0;i<this.frames.length;i++)e.data[a]+=this.frames[i].data[a]/this.frames.length*(i/this.frames.length)*2,e.data[a+1]+=this.frames[i].data[a+1]/this.frames.length*(i/this.frames.length)*2,e.data[a+2]+=this.frames[i].data[a+2]/this.frames.length*(i/this.frames.length)*2;e.data[a+3]=255}return e},CLARITY.Puzzler=function(t){var t=t||{};this.width=640,this.height=480,this.selected,this.splits=8,this.swaps=[];for(var e=0,a=0;a<this.splits;a++){this.swaps[a]=[];for(var i=0;i<this.splits;i++)this.swaps[a][i]=e++}for(var a=0;a<10*this.splits;a++){var r=Math.floor(Math.random()*this.splits),h=Math.floor(Math.random()*this.splits),s=Math.floor(Math.random()*this.splits),o=Math.floor(Math.random()*this.splits),d=this.swaps[r][h];this.swaps[r][h]=this.swaps[s][o],this.swaps[s][o]=d}CLARITY.Filter.call(this,t)},CLARITY.Puzzler.prototype=Object.create(CLARITY.Filter.prototype),CLARITY.Puzzler.prototype.process=function(t){for(var e=this.ctx.createImageData(t.width,t.height),a=this.height/this.splits,i=this.width/this.splits,r=0;r<this.splits;r++)for(var h=0;h<this.splits;h++)for(var s=this.numToPos(this.swaps[h][r]),o=0;a>o;o++)for(var d=0;i>d;d++){var n=4*((r*a+o)*t.width+(h*i+d)),l=4*((s[1]*a+o)*t.width+(s[0]*i+d)),c=this.getPixel(t.data,l);e.data[n]=c[0],e.data[n+1]=c[1],e.data[n+2]=c[2],e.data[n+3]=255}if(void 0!=this.selected)for(var r=0;r<this.height/this.splits;r++)for(var h=0;h<this.width/this.splits;h++){var n=4*((this.selected[1]*(this.height/this.splits)+r)*this.width+(this.selected[0]*(this.width/this.splits)+h));e.data[n+2]+=80}return e},CLARITY.Puzzler.prototype.getPixel=function(t,e){return[t[e],t[e+1],t[e+2]]},CLARITY.Puzzler.prototype.setPixel=function(t,e,a,i){var r=4*(a*this.width+e);t.data[r]=i[0],t.data[r+1]=i[1],t.data[r+2]=i[2]},CLARITY.Puzzler.prototype.setClick=function(t){var e=Math.floor(t[0]/(this.width/this.splits)),a=Math.floor(t[1]/(this.height/this.splits));if(this.selected){var i=this.swaps[this.selected[0]][this.selected[1]];this.swaps[this.selected[0]][this.selected[1]]=this.swaps[e][a],this.swaps[e][a]=i,this.selected=void 0}else this.selected=[e,a]},CLARITY.Puzzler.prototype.numToPos=function(t){for(var e=0,a=0;t>this.splits-1;)t-=this.splits,e++;return a=t,[e,a]};